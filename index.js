(()=>{var e={5193:(e,t,s)=>{const i=s(6217),r=s(3882),a=s(4408),{ValidationError:o}=s(5636),n=s(8370);e.exports={record:async function(e,t){const s=new i;if(s.load(e.body.session_id),a.isRecording())t.send({status:"recording",message:"Already recording."});else try{await a.record(s,e.body.side),t.send({status:"recording"})}catch(e){t.send({status:"failed",reason:e.message})}},stop:async function(e,t){let s=await a.stop();t.send(s)},storePostCapture:async function(e,t){try{let s=new i;await s.load(e.params.id);let a=await s.getRecording(e.params.side),o=await n.get(`PostCapture-${a.id}`);if(o)return console.log("CaptureController.storePostCapture, job exists..."),t.send({job:o.instance.getJobState()});let c=new r(s,e.params.side),l=await n.start("PostCapture",c);t.send({job:l})}catch(e){throw console.log(e),new o("Validation errors.",{session_id:[e.message]})}}}},202:(e,t,s)=>{const i=s(5653),r=s(9450);e.exports={proxyHandler:async function(e){e.register(r,{upstream:"https://burntable.com",http2:!1,prefix:"/bt",replyOptions:{rewriteRequestHeaders:(e,t)=>{console.log("rewriteRequestHeaders",i.getBearer());let s={...t,authorization:"Bearer "+i.getBearer(),accept:"application/json"};return delete s.dspin,s},rewriteHeaders:e=>({...e,"x-bt-token":i.getBearer()})}})},authHandler:async function(e){e.put("/token",(async(e,t)=>{const s=await i.setBearer(e.body.token);t.send({token:s})})),e.delete("/token",(async(e,t)=>{await i.deleteBearer(),t.send({result:"disconnected"})}))}}},2714:(e,t,s)=>{s(5653);const i=s(9189),r=s(6217),a=s(8370),{ValidationError:o}=(s(53),s(5636));e.exports={ensureSync:async function(e,t){try{const s=e.params.id;let o=new r;await o.load(s);let n=await a.get(`BurntableSync-${o.id}`);if(n)return t.send({job:n.instance.getJobState()});let c=new i(o),l=await a.start("BurntableSync",c);t.send({job:l})}catch(e){throw console.error(e),new o("Validation errors.",{session_id:[e.message]})}}}},7534:(e,t,s)=>{const i=s(6737);e.exports={index:async function(e,t){t.send(await i.index())},update:async function(e,t){if("object"!=typeof e.body)throw new Error("Missing application/json Content-type header");t.send(await i.update(e.body))},debug:async function(e,t){t.send(await i.debug())},getSoftMon:async function(e,t){t.send({softmon:await i.getSoftwareMonitorState()})},putSoftMon:async function(e,t){t.send({softmon:await i.setSoftwareMonitorState(!!e.body.softmon)})}}},6863:(e,t,s)=>{s(7147);const i=s(6217);e.exports={upload:async function(e,t){let s=e.params.id,r=new i;r.load(s),console.log(`Storing image for session ${s}`);try{const t=await e.saveRequestFiles();await r.updateImage(t[0].filepath),console.log(`Stored image for session ${s}`)}catch(e){console.error("Failed to update image",e.message,e)}t.send({...r})}}},9763:(e,t,s)=>{const i=s(8370),r=s(6815);e.exports={store:async function(e,t){let s=new r,a=await i.start("MockJob",s);t.send({job:a})},index:async function(e,t){t.send(await i.index())},destroy:async function(e,t){const s=e.params.id;console.log(`Request to destroy job ${s}`),t.send({result:await i.destroy(s)})}}},8558:(e,t,s)=>{const i=s(5898);e.exports={get:async function(e,t){const s=await i.getPinHash();let r={protected:!!s,authenticated:!s||!(!e.headers.dspin||e.headers.dspin!==s)};t.send(r)},post:async function(e,t){const s=await i.updatePinHash(null,e.body.new_pin);t.send({result:"success",dspin:s})},put:async function(e,t){const s=await i.updatePinHash(e.body.current_pin,e.body.new_pin);t.send({result:"success",dspin:s})},del:async function(e,t){},authentication:async function(e,t){const s=await i.authenticate(e.body.pin);t.send({result:"success",dspin:s})}}},8264:(e,t,s)=>{const i=s(6217),r=s(6212),a=s(8370),{ValidationError:o}=s(5636);e.exports={store:async function(e,t){try{const s=e.params.id;let o=new i;await o.load(s),o.normalized;let n=await a.get(`Normalizer-${s}`);if(n)return t.send({job:n.instance.getJobState()});let c=new r(o),l=await a.start("Normalizer",c);t.send({job:l})}catch(e){throw new o("Validation errors.",{session_id:[e.message]})}}}},3666:(e,t,s)=>{s(3271);const i=s(5653),r=s(6552),a=s(6217),o=s(7567);e.exports={play:async function(e,t){try{if("Session"===e.body.context_type){let s=new a;await s.load(e.body.context_id);let i=new o({context_type:"Session",context_id:s.id,rate:e.body.recording.rate,format:e.body.recording.format,bits:e.body.recording.bits,album:s.title,title:`Side ${e.body.recording.side}`,uri:e.body.recording.file,image:s.image,context:s});await r.play(i),t.send({playable:{...i}})}else if("Drop"===e.body.context_type){const s=await i.getClient().post("plays",{drop_id:e.body.context_id,side:e.body.side,format:"aac"});let a=s.data.drop,n=new o({title:`Side ${e.body.side}`,track:e.body.side,album:a.release_version.title,artist:a.release_version.artist.title,image:a.photo.url,uri:s.data.audio.url,id_discogs:a.release_version.id_discogs,rate:96e3,bits:24,format:s.data.audio.codec,context_type:"Drop",context_id:a.id,context:a});try{await r.play(n)}catch(e){console.error(e)}t.send({playable:{...n}})}}catch(e){t.send({error:e.message})}},togglePlay:async function(e,t){try{await r.togglePlay()}catch(e){console.error(`togglePlay Error: ${e.message}`)}t.send({status:"done"})},quit:async function(e,t){try{await r.quit()}catch(e){}t.send({status:"stopped"})},fastForward:async function(e,t){try{await r.fastForward()}catch(e){}t.send({status:"done"})},skipNext:async function(e,t){t.send({status:"done"})},skipPrevious:async function(e,t){t.send({status:"done"})},rewind:async function(e,t){try{await r.rewind()}catch(e){}t.send({status:"done"})},init:async function(e,t){await r.init(),t.send({init:!0})}}},6105:(e,t,s)=>{const i=s(3489),{ValidationError:r}=s(5636);e.exports={index:async function(e,t){t.send(i.all())},update:async function(e,t){let s={},a=i.keys();for(const t of Object.keys(e.body))if(!a.indexOf(t)<0)console.error("Invalid key for preferences",t);else try{i.set(t,e.body[t])}catch(e){s[t]=[e.message]}if(Object.keys(s).length>0)throw new r("Validation errors.",s);t.send(i.all())}}},6714:(e,t,s)=>{const i=s(6217),r=(s(3619),s(8370)),a=s(1272),{ValidationError:o}=(s(7147),s(1017),s(5636));e.exports={storeReversion:async function(e,t){const s=e.params.id,n=e.body.state,c=new i;c.load(s);const l=await c.getRecordingBySide(e.params.side);if(l.cleaned_up)throw new o("Cannot undo after cleanup",{side:["Cannot undo after cleanup. Undo files are gone."]});let d=await r.get(`Reverter-Recording-${l.id}`);if(d)return t.send({job:d.instance.getJobState()});const p=new a(c,"Recording",l.id,n);let u=await r.start("Reverter",p);t.send({job:u})}}},2945:(e,t,s)=>{const i=s(6217),r=s(3619),a=s(7147),{ValidationError:o}=(s(1017),s(5636));e.exports={index:async function(e,t){console.log("GET /sessions",`${r.dataDir}/sessions`);let s=a.readdirSync(`${r.dataDir}/sessions`,{withFileTypes:!0}).filter((e=>e.isDirectory()&&e.name.indexOf(".")<0)),i=s.map((e=>JSON.parse(a.readFileSync(`${r.dataDir}/sessions/${e.name}/session.json`,"utf-8")))).sort((function(e,t){return parseFloat(t.updated_at)-parseFloat(e.updated_at)}));e.query&&e.query.search&&console.log("controllers/session/search",e.query.search),t.send({data:i,total:s.length})},store:async function(e,t){let s=new i;return await s.create(e.body),{...s}},read:async function(e,t){let s=e.params.id,r=new i;r.load(s),t.send({...r})},update:async function(e,t){let s=e.params.id,r=new i;console.log(`PUT /sessions/${s} - ${JSON.stringify(e.body)}`);try{r.load(s),await r.update(e.body)}catch(e){console.error(`PUT /sessions/${s} failed: ${JSON.stringify(e)}`)}t.send({...r})},destroy:async function(e,t){let s=e.params.id;try{a.rmSync(`${r.dataDir}/sessions/${s}`,{recursive:!0})}catch(e){console.log("Nothing to delete")}t.send({id:s})},deleteRecording:async function(e,t){let s=e.params.id,r=e.params.side,a=new i;a.load(s),await a.deleteSide(r),t.send({...a})},getRecording:async function(e,t){let s=e.params.id,r=e.params.side,a=new i;a.load(s);const o=await a.getRecordingBySide(r);let n=await o.getInfo(),c=await o.debug();t.send({...o,info:n,debug:c})},updateReleaseVersion:async function(e,t){let s=e.params.id,r=new i;if(r.load(s),!e.body||!e.body.release_version||!e.body.release_version.id)throw new o("No release version.",{release_version:["Not a valid release version"]});r.updateReleaseVersion(e.body.release_version),t.send({...r})},cleanup:async function(e,t){let s=e.params.id,r=new i;r.load(s);const a=await r.cleanup();t.send({message:"Cleaned up",report:a,session:{...r}})}}},4143:(e,t,s)=>{const i=s(6217),{ValidationError:r}=s(5636),a=s(4839),o=s(8370);s(53),e.exports={store:async function(e,t){if(!e.body.tracks)throw new r("Missing",{tracks:["Tracks are required."]});let s=e.body.tracks;Array.isArray(s)||(s=[s]);let a=new i;a.load(e.params.id);for(const e of s)if(!e.side||!e.title||!e.position)throw new r("Missing",{tracks:["Track must have side, position and title."]});t.send({data:await a.ensureTracksForSession(s)})},destroy:async function(e,t){let s=new i;s.load(e.params.id);let a=e.params.side,o=e.params.position;if(!a||!o)throw new r("Invalid side position",{tracks:["Track must have side position to delete."]});await s.removeTrackForSession({side:a,position:o}),t.send({message:"deleted"})},process:async function(e,t){const s=e.params.id,n=e.params.side;console.log(`track process for ${s} ${n}`);try{let e=new i;e.load(s),console.log(`Session ${e.title} loaded`);let r=await e.getRecordingBySide(n),c=await o.get(`Splitter-${r.id}`);if(c)return t.send({job:c.instance.getJobState()});let l=new a(e,n),d=await o.start("Splitter",l);t.send({job:d})}catch(e){throw console.error(e),new r("Validation errors.",{session_id:[e.message]})}},index:async function(e,t){let s=new i;s.load(e.params.id);let r=e.params.side,a=await s.getTracks();r&&(a=a.filter((e=>e.side===r))),t.send({data:a})}}},5852:(e,t,s)=>{const i=s(6217),{ValidationError:r}=s(5636),a=s(53),o=s(8370);e.exports={store:async function(e,t){for(const t of["from","to"])if(0!==e.body[t]&&(!e.body[t]||isNaN(parseFloat(e.body[t]))))throw new r("Validation errors.",{[t]:[`${t} is required and must be numeric`]});try{const s=e.params.id,r=e.params.side;let n=new i;await n.load(s);let c=await n.getRecordingBySide(r),l=await o.get(`Trimmer-${c.id}`);if(l)return t.send({job:l.instance.getJobState()});let d=new a(n,r,e.body.from,e.body.to),p=await o.start("Trimmer",d);t.send({job:p})}catch(e){throw new r("Validation errors.",{session_id:[e.message]})}}}},7232:(e,t,s)=>{const{spawn:i,exec:r,execSync:a}=s(2081);e.exports={store:async function(e,t){try{let e=await async function(){return new Promise(((e,t)=>{r("sudo apt-get --yes install mp3splt flac",((e,t,s)=>{e&&console.error("Failed to install startup packages"),console.log("installed: mp3splt")})),r("cd /home/ds/ds-fw-dist && git fetch --all && git reset --hard origin/master && yarn install && sudo chmod 755 ./init.sh && sudo chmod 755 ./update.sh && sudo chmod 755 ./wifi-connect/start-wifi-connect.sh",((s,i,r)=>{if(s)return console.error("Failed to update firmware",s.message),void t(s);e(i)}))}))}();t.send({message:"Update completed",result:e}),async function(){return new Promise(((e,t)=>{try{a("ln -s /dropstation/data /dropstation/shared/data")}catch(e){console.error("Failed to create symlink to raw data",e.message)}r("sudo service ds restart",((s,i,r)=>{s?t(s):e("Updated.")}))}))}().then((e=>{console.log(`restartDropStation...${e}`)}))}catch(e){t.send({message:"Update failed",result:JSON.stringify(e)})}}}},437:(e,t,s)=>{const i=s(6737),r=s(7147);e.exports={fixMount:async function(e,t){if(console.log("Running fixMount"),(await i.dumpCommand("lsblk")).stdout.match(/\/dropstation/))return console.log("Already mounted /dropstation, finishing."),t.send({message:"Already mounted /dropstation, finishing."});const s="/dropstation-tmp";try{r.existsSync(s)?console.log(`Temp directory ${s} already exists.`):(console.log(`Moving /dropstation to ${s}`),await i.dumpCommand("sudo mv /dropstation /dropstation-tmp"))}catch(e){return console.error(`Failed to create temp directory, aborting: ${e.message}`),t.send({message:`Failed to create temp directory, aborting: ${e.message}`})}try{console.log("Formatting new SSD to xfs");let e=await i.dumpCommand('sudo mkfs.xfs -f /dev/sda -L "USBAudio"');console.log("Format results",e),console.log("mounting at /dropstation");let s=await i.dumpCommand("sudo mkdir /dropstation && sudo mount /dev/sda /dropstation");return console.log("Mount results",s),s.stderr?(console.error("Aborting for data safety reasons."),t.send({message:`Aborting for data safety reasons: ${s.stderr}`})):(console.log("Moving files from temp director to /dropstation"),i.dumpCommand("sudo rsync -axuv /dropstation-tmp/ /dropstation/").then((e=>{console.log("Finished rsync.  Temp files are done being moved.",e)})),console.log('Setting user "ds" as owner to /dropstation'),await i.dumpCommand("sudo chown ds:pi -R /dropstation"),console.log("Done. Successfully migrated to new SSD"),t.send({message:"Moving files in background.  This may take a few minutes."}))}catch(e){return console.error(`Fatal error: ${e.message}`),t.send({message:`Fatal error: ${e.message}`})}},copyTempFiles:async function(e,t){try{return r.existsSync("/dropstation-tmp")?(i.dumpCommand("sudo rsync -axuv /dropstation-tmp/ /dropstation/").then((async e=>{console.log("Finished rsync.  Temp files are done being moved.",e),await i.dumpCommand("sudo chown ds:pi -R /dropstation")})).catch((e=>{console.log(`Copying rsync failure: ${e.message}`)})),t.send({message:'Temp files are being moved.  This may take a while.  Please see "Report" output for "Finished rsync"'})):t.send({message:"There is no temp directory"})}catch(e){return console.error("Failed to copy temp directory",e),t.send({message:`Failed to copy temp directory, aborting: ${e.message}`})}}}},3361:(e,t,s)=>{const{spawn:i,exec:r,execSync:a}=s(2081),{EventEmitter:o}=s(1239),n=s(3489),c=s(3619),l=s(4913),d=s(4610);e.exports=new class extends o{jackd;duration;lastSampleRate;sampleRateMap={shared:{48e3:{n:4,p:2048,m0:"dl",m1:"dl"},96e3:{n:4,p:4096,m0:"dh",m1:"dl"},192e3:{n:8,p:8192,m0:"dl",m1:"dh"}},dedicated:{48e3:{n:4,p:1024,m0:"dl",m1:"dl"},96e3:{n:4,p:2048,m0:"dh",m1:"dl"},192e3:{n:8,p:2048,m0:"dl",m1:"dh"}}};constructor(){super();try{a("export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/dbus/system_bus_socket")}catch(e){console.error("Failed to export DBUS_SESSION_BUS_ADDRESS")}}async init(){}getSampleRateMap(){return c.dataIsMount?this.sampleRateMap.dedicated:this.sampleRateMap.shared}async isRunning(e){let t=process.platform,s="";switch(t){case"win32":s="tasklist";break;case"darwin":s=`ps -ax | grep ${e}`;break;case"linux":s="ps -A"}return this.emit("debug",`Checking jackd process status with ${s}`),new Promise(((t,i)=>{r(s,((s,i,r)=>{let a=i.toLowerCase().indexOf(e.toLowerCase())>-1;this.emit("debug",`Result of JackManager.isRunning(): ${a}`),t(a)}))}))}async ensure(e,t){let s=this;if(this.jackd&&!t)return this.emit("debug","Jackd is already running, no forceRestart requested."),this.jackd;if(await this.isRunning("jackd")){if(!t)return void this.emit("debug","jackd is already running");this.emit("debug","Jack ensure() forceRestart, killing jackd"),await this.kill()}!e||[48,96,192].indexOf(e)<0?(this.emit("debug","JackManager.ensure received no sampleRate, using default."),e=96e3):e*=1e3,this.lastSampleRate=e,await this.changeSampleRate(e),this.emit("debug",`JackManager.ensure starting with a sampleRate of ${e}.`);const r=await l.getCards();return console.log("JackManager.ensure() driver returned cards: ",r),this.jackd=i("jackd",["-r","-d","alsa","-i","2","-o","2","-r",e,"-n",this.getSampleRateMap()[e].n,"-p",this.getSampleRateMap()[e].p,"-C",r.capture,"-P",r.playback],{env:{...process.env,JACK_NO_AUDIO_RESERVATION:"1",DBUS_SESSION_BUS_ADDRESS:"unix:path=/run/dbus/system_bus_socket"}}),new Promise(((e,t)=>{let i=setTimeout((()=>{t("Failed to start jackd within 10 seconds.  Check error logs and contact support.")}),1e4);this.jackd.on("exit",(function(e,t){s.jackd=null,e?s.emit("exit",`jackd exited with code ${e}`):t?s.emit("exit",`jackd exited with signal ${t}`):s.emit("exit","jackd exited on completion")})),this.jackd.on("close",(function(e,t){s.jackd=null,s.emit("close",`jackd closed with code ${e} and signal ${t}`)})),this.jackd.stdout.on("data",(function(t){let r=t.toString();console.log("jackd stdout",t.toString()),r.indexOf("periods for playback")>-1&&(clearTimeout(i),setTimeout((()=>{e("jackd started")}),1e3)),s.emit("data",t)})),this.jackd.stderr.on("data",(function(e){s.emit("error",e?e.toString():"no error data")}))}))}async changeSampleRate(e){if(!this.getSampleRateMap()[e])throw console.error(`JackManager.changeSampleRate() not a valid rate: ${e}`),Error(`${e} is not a valid sample rate`);await l.changeSampleRate(e)}async adcSleep(){console.log("JackManager.adcSleep()");try{return await l.sleep(),!0}catch(e){return!1}}async toggleSoftwareMonitor(){return await this.getSoftwareMonitorState()?this.setSoftwareMonitorState(!1):this.setSoftwareMonitorState(!0)}async setSoftwareMonitorState(e){let t;if(e){if(console.log("setSoftwareMonitorState: checking if jackd is running."),!await this.isJackdRunning()){let e=n.get("captureSampleRate");console.log("setSoftwareMonitorState: jackd is not running, starting."),await this.ensure(e),console.log("setSoftwareMonitorState: jackd is started.")}t="jack_connect system:capture_1 system:playback_1 && jack_connect system:capture_2 system:playback_2"}else t="jack_disconnect system:capture_1 system:playback_1 && jack_disconnect system:capture_2 system:playback_2";try{console.log("Running: ",t);let s=a(t);return console.log("result",s.toString()),e}catch(e){return!1}}async getSoftwareMonitorState(){if(!await this.isJackdRunning())return!1;let{stdout:e,stderr:t}=a("jack_lsp -c");return console.log({stdout:e,stderr:t}),!!e.match(/system:capture_1\s+system:playback_1/gm)}async kill(){try{this.emit("debug","JackManager.kill() attempting to kill jackd process"),a("sudo killall jackd"),await d.sleep(300),this.emit("debug","JackManager.kill() succeeded.")}catch(e){this.emit("debug",`JackManager.kill() says ${e.message}`)}}async isJackdRunning(){return this.isRunning("jackd")}async killIfRunning(){return!!await this.isRunning("jackd")&&(await this.kill(),!0)}}},267:(e,t,s)=>{e.exports=class{dataDir;recordingProcess;meteringProcess;averageLevelInterval;averageLevelIntervalMs=3e3;averageLevelSamples=[];averageLevel=0;constructor(e){this.dataDir=e.dataDir}async stop(){return this.recordingProcess.kill("SIGTERM")}meter(e){const t=this,{spawn:i}=s(2081);this.averageLevelInterval=setInterval((()=>{this.setAverageLevel(this.averageLevelSamples.reduce(((e,t)=>e+t),0)/this.averageLevelSamples.length),this.averageLevelSamples=[]}),this.averageLevelIntervalMs),this.meteringProcess=i("arecord",["-D","pulse","-f","dat","-c","2","-vv","/dev/null"],{stdio:["ignore","ignore","pipe"]}),this.meteringProcess.stderr.on("data",(function(s){let i=parseInt(String(s).substr(54,2));isNaN(i)||(t.averageLevelSamples.push(i),e&&e(i))}))}setAverageLevel(e){this.averageLevel=e,console.log("Average level",e)}async recordSideForSession(e,t){return this.record(`${t.id}-${e}`)}async record(e){const{spawn:t}=s(2081);return new Promise(((s,i)=>{this.recordingProcess=t("parec",["--rate=96000","--format=s24le","-d","alsa_input.platform-soc_sound.stereo-fallback","|","sox","-t","raw","-b","24","-e","signed","-c","2","-r","96000","-",`${this.dataDir}/${e}.wav`],{stdio:["ignore","ignore","pipe"]}),this.recordingProcess.on("close",((e,t)=>{s({code:e,signal:t})}))}))}}},5898:(e,t,s)=>{const i=s(7096),r=(s(1017),s(7147)),a=s(3619),{ValidationError:o}=s(5636),n=`${a.rootDataDir}/.PIN`;let c,l=null,d=0;async function p(e){const t=await i.hash(String(e),5);return r.writeFileSync(n,t,{encoding:"utf8",flag:"w"}),l=t,t}async function u(){if(l)return l;try{if(r.existsSync(n))return l=r.readFileSync(n,"utf8"),l}catch(e){return null}}e.exports={updatePinHash:async function(e,t){if(!/[0-9]{4}/.test(t))throw new o("Current pin entered is incorrect.",{new_pin:["Must be 4 numbers."]});const s=await u();if(!s)return console.log("updatePinHash has no currentPinHash, setting to newPin",t),p(t);if(!await i.compare(String(e),String(s)))throw new o("Current pin entered is incorrect.",{current_pin:["Incorrect pin entered."]});return p(t)},getPinHash:u,authenticate:async function(e){if(d++,d>=5&&(c&&clearTimeout(c),c=setTimeout((()=>{d=0}),15e3),1))throw new o("Please try again in 15 seconds.",{pin:["Please wait 15 seconds and try again..."]});const t=await u();if(!t)throw new o("Current pin entered is incorrect.",{pin:["Please set a pin before trying to authenticate."]});if(!await i.compare(String(e),String(t)))throw new o("Incorrect pin sorry.",{current_pin:["Incorrect pin entered."]});return t}}},5653:(e,t,s)=>{s(1017);const i=s(7147),r=s(2167),a=s(3619),{sleep:o}=s(4610);let n=null;const{ValidationError:c}=s(5636),l=`${a.rootDataDir}/.BTBEARER`;let d=null;function p(){if(console.log("burntable.getBearer()"),d)return console.log("using bearer cache",d),d;try{if(i.existsSync(l))return d=i.readFileSync(l,"utf8").trim(),console.log("Setting BT_BEARER_CACHE",d),d;console.log("burntable.getBearer(): No bearer file --",l)}catch(e){return console.error("burntable.getBearer exception",e),console.log("No bearer file",l),null}}e.exports={getBearer:p,setBearer:async function(e){return console.log(`burntable.setBearer ${e}`),i.writeFileSync(l,e.trim(),{encoding:"utf8",flag:"w"}),console.log("burntable.setBearer stored to file"),await o(150),console.log("burntable.setBearer waited 150ms"),d=e,e},deleteBearer:async function(){try{i.rmSync(l),d=null}catch(e){console.error("Failed to delete burntable bearer file.")}return!0},getClient:function(){if(n){let e=p();return e&&(n.defaults.headers.authorization="Bearer "+e),n}return n=r.create({baseURL:"https://burntable.com/api",headers:{accept:"application/json","content-type":"application/json"}}),n.defaults.headers.authorization="Bearer "+p(),console.log("getClient axiosInstance.defaults.headers",n.defaults.headers),n}}},9549:(e,t,s)=>{const i=s(4913),r=s(4525);let a=null,o=0,n=null,c=null;e.exports={observe:async function(e){await i.onButtonState((function(t){t?(a&&(console.warn("Button observer had a pre-existing holdInterval."),clearInterval(a)),a=setInterval((()=>{o++,2===o?"wants_reboot"!=n&&(n="wants_reboot",r.flashAll(1,800),e("wants_reboot")):4===o?"wants_sleep"!=n&&(n="wants_sleep",r.flashAll(2,800),e("wants_sleep")):29===o?"wants_factory_reset"!=n&&(r.flashAll(8,250),n="wants_factory_reset",e("wants_factory_reset")):o>40&&(o=0,n=null,clearInterval(a))}),1e3)):(o>29?"factory_reset"!=n&&(n="factory_reset",e("factory_reset")):o>=4?"sleep"!=n&&(n="sleep",e("sleep")):o>=2?"reboot"!=n&&(n="reboot",e("reboot")):"stop"!=n&&(n="stop",e("stop")),null===c&&(c=setTimeout((()=>{n=null,clearTimeout(c),c=null}),250)),o=0,a&&(clearInterval(a),a=null))}))}}},6212:(e,t,s)=>{const i=s(5597),r=s(2353),{spawn:a}=s(2081),o=s(7147),n=s(4386);e.exports=class extends i{session;jobState;normalizedFiles=[];maxVolumes=[];maxVolumeProcs=[];applyGainProcs=[];reportingInterval;constructor(e){super(),this.session=e}getId(){return this.session?`Normalizer-${this.session.id}`:null}getTitle(){return`Peak normalizing ${this.session.title} audio`}async getJobState(){return this.jobState}async initJobState(){this.jobState={object:"Session",object_id:this.session.id,data:{...this.session},id:this.getId(),title:`Normalizing ${this.session.title}`,name:"normalize",status:"Queued...",state:"queued",completed:!1,progress:!0},this.reportingInterval=setInterval((()=>{this.jobState.data={...this.session},n.pub("job",this.jobState)}),3e3)}async stop(){await this.killProcesses([...this.maxVolumeProcs,...this.applyGainProcs]),await this.removeFiles(this.normalizedFiles),this.reportingInterval&&clearInterval(this.reportingInterval)}async process(){return this.jobState.state="running",(async()=>{for(const e of this.session.recordings){this.jobState.status=`Getting max volume of side ${e.side}`;let t=await this.getMaxVolume(e.file);if(null===t)throw new Error(`Failed to determine max volume of audio ${e.id} in ${e.file}.`);this.jobState.status=`Max volume of side ${e.side}: ${t}`,this.maxVolumes.push(t)}this.maxVolume=Math.max(...this.maxVolumes);const e=Math.abs(this.maxVolume);this.jobState.status=`Gain required: ${e}dB`;for(const t of this.session.recordings){this.jobState.status=`Applying gain to side ${t.side}`;let s=await this.applyGain(new r(t),e);t.file=s,t.state="normalized",this.session.ensureRecording(t)}this.session.normalized=!0,await this.session.save()})().then((()=>{console.log("Normalizer.process() done"),n.pub("store",{name:"session",data:{...this.session}})})).catch((e=>{console.error("Normalizer.process.catch",e),this.jobState.state="failed",this.jobState.error=`Normalization failed: ${e.message||e}`})).finally((()=>{this.reportingInterval&&clearInterval(this.reportingInterval),this.jobState.state="completed",this.jobState.completed=!0,n.pub("job",this.jobState)})),this.jobState}async applyGain(e,t){const s=e.pathForVariant("file","normalized");let i=["-hide_banner","-y","-i",e.file],r="";if(!(t>0))return o.copyFileSync(e.file,s),s;r=`volume=${t}dB`;const n=`${r}`;return i.push("-filter_complex"),i.push(n),i.push(s),console.log("Normalizer.applyGain() rawArgs",i),new Promise(((t,r)=>{if(e.file===s)return r(`Side ${e.side} already normalized. Please reset session to capture state.`);const n=a("ffmpeg",i);n.on("error",(e=>{r(e)})),n.on("close",(()=>{console.log("applyGainProc CLOSE (ignoring)")})),n.on("exit",(()=>{console.log("applyGainProc EXIT"),o.existsSync(s)?(this.normalizedFiles.push(s),t(s)):r("Normalizer failed to create output file")})),n.stdout.on("data",(e=>{console.log("applyGain.stdout",e.toString())})),n.stderr.on("data",(e=>{console.log("applyGain.stderr",e.toString())})),this.applyGainProcs.push(n)}))}async getMaxVolume(e){let t=`-hide_banner -i ${e} -af volumedetect -f null /dev/null`;return new Promise(((e,s)=>{const i=a("ffmpeg",t.split(" "));let r=!1;i.on("error",(e=>{s(e)})),i.on("close",(()=>{console.log("getMaxVolume CLOSE (ignoring)")})),i.on("exit",(()=>{setTimeout((()=>{r||e(null)}),250)})),i.stdout.on("data",(e=>{})),i.stderr.on("data",(t=>{let s=t.toString().match(/max_volume:\s(-?\d+\.\d+)/i);if(s){r=!0;let t=parseFloat(s[1]);return console.log("getMaxVolume",t),e(t)}})),this.maxVolumeProcs.push(i)}))}}},3882:(e,t,s)=>{const i=s(4386),{spawn:r}=s(2081),{unlinkSync:a}=(s(1041),s(7147)),o=(s(8370),s(5597));e.exports=class extends o{session;side;recording;reportingInterval;jobState;referenceProc;referenceFile;waveformProc;waveformFile;constructor(e,t){super(),this.session=e,this.side=t}getId(){return this.recording?`PostCapture-${this.recording.id}`:null}getTitle(){return this.recording&&this.session?`${this.session.title} Side ${this.recording.side} post-capture`:null}async getJobState(){return this.jobState}async initJobState(){return this.recording=await this.session.getRecordingBySide(this.side),this.jobState={object:"Recording",object_id:this.recording.id,data:{...this.recording},id:this.getId(),title:`Post-capture for Side ${this.side}`,name:"waveform",status:"Queued...",state:"queued",completed:!1,progress:!0},this.reportingInterval=setInterval((()=>{this.jobState.data={...this.recording},i.pub("job",this.jobState)}),3e3),this.jobState}async stop(){return await this.killProcesses([this.referenceProc,this.waveformProc]),await this.removeFiles([this.referenceFile,this.waveformFile]),this.reportingInterval&&clearInterval(this.reportingInterval),this.recording.post_capturing=!1,this.recording.post_captured=!1,this.jobState.state="stopped",this.jobState.error="Manually stopped",i.pub("job",this.jobState),this.session.ensureRecording(this.recording)}async process(){return this.debug("process() initializing"),this.jobState.state="running",this.recording=await this.session.getRecordingBySide(this.side),this.recording.post_capturing,this.recording.post_capturing=!0,await this.session.ensureRecording(this.recording),(async()=>{const e=await this.generateReference(),t=await this.generateWaveformSource(this.recording.file);this.recording.waveform=await this.generateWaveform(t);try{a(t)}catch(e){console.error(`Failed to unlink waveformSource ${t}`)}this.recording.reference=e,this.recording.post_captured=!0,this.recording.state="post_captured",await this.recording.syncFileInfo()})().then((()=>{this.debug("process() finished without error"),this.jobState.state="completed"})).catch((e=>{this.debug("process() exception"),this.jobState.state="failed",this.jobState.error=`Post capture failed: ${e.message}`})).finally((async()=>{this.reportingInterval&&clearInterval(this.reportingInterval),this.debug("process() finally()"),this.jobState.completed=!0,this.recording.post_capturing=!1,this.jobState.data={...this.recording},console.log(`PostCapture saving recording: ${JSON.stringify(this.recording)}`),await this.session.ensureRecording(this.recording),i.pub("job",this.jobState),this.debug(`PostCapture.process() finally() ${this.jobState.id} state = ${this.jobState.state}`)})),this.jobState}debug(e){console.log(`PostCapture:${this.session.id}:${this.side} - ${e}`)}async generateReference(){this.referenceFile=this.recording.pathForVariant("reference","post_captured"),this.jobState.status="Generating optimized audio for editing";let e=`-hide_banner -y -i ${this.recording.file} -ar 48000 -b:a 128k ${this.referenceFile}`;return new Promise(((t,s)=>{this.referenceProc=r("ffmpeg",e.split(" ")),this.referenceProc.on("error",(e=>{s(e)})),this.referenceProc.on("close",(()=>{})),this.referenceProc.on("exit",(()=>{setTimeout((()=>{t(this.referenceFile)}),250)})),this.referenceProc.stdout.on("data",(e=>{})),this.referenceProc.stderr.on("data",(e=>{}))}))}async generateWaveformSource(e){this.debug(`generateWaveformSource() from ${e}`);let t=`${e}.wav`,s=`-hide_banner -y -i ${e} -ar 8000 ${t}`;return new Promise(((e,i)=>{const a=r("ffmpeg",s.split(" "));a.on("error",(e=>{i(e)})),a.on("close",(()=>{this.debug("generateWaveformSource CLOSE")})),a.on("exit",(()=>{this.debug("generateWaveformSource EXIT"),setTimeout((()=>{this.debug("generateWaveformSource resolve()"),e(t)}),250)})),a.stdout.on("data",(function(e){})),a.stderr.on("data",(function(e){}))}))}async generateWaveform(e){this.waveformFile=this.recording.pathForVariant("waveform","post_captured");let t=`-y -i ${e} -filter_complex compand=gain=6,aformat=channel_layouts=mono,showwavespic=s=7200x240:colors=white -frames:v 1 ${this.waveformFile}`;return this.jobState.status="Creating high resolution waveform for editing",new Promise(((e,s)=>{this.waveformProc=r("ffmpeg",t.split(" ")),this.waveformProc.on("error",(e=>{s(e)})),this.waveformProc.on("close",(()=>{})),this.waveformProc.on("exit",(()=>{setTimeout((()=>{e(this.waveformFile)}),250)})),this.waveformProc.stdout.on("data",(e=>{})),this.waveformProc.stderr.on("data",(e=>{}))}))}}},2353:(e,t,s)=>{const{exec:i}=s(2081),{existsSync:r}=s(7147),a=s(3619),o=s(7147),n={original:[{name:"file",template:"%side.original.flac",legacyTemplate:"%side.flac"}],post_captured:[{name:"file",template:"%side.original.flac",legacyTemplate:"%side.flac"},{name:"reference",template:"%side.original.mp3",legacyTemplate:"%side.flac.mp3"},{name:"waveform",template:"%side.original.png",legacyTemplate:"%side.flac.png"}],trimmed:[{name:"file",template:"%side.trimmed.flac",legacyTemplate:"%side.flac.t.flac"},{name:"reference",template:"%side.trimmed.mp3",legacyTemplate:"%side.flac.mp3.t.mp3"},{name:"waveform",template:"%side.trimmed.png",legacyTemplate:"%side.flac.png.t.png"}],normalized:[{name:"file",template:"%side.normalized.flac"},{name:"reference",template:"%side.trimmed.mp3",legacyTemplate:"%side.flac.mp3.t.mp3"},{name:"waveform",template:"%side.trimmed.png",legacyTemplate:"%side.flac.png.t.png"}]};e.exports=class{id;session_id;created_at;post_captured=!1;post_capturing=!1;file;reference;waveform;side;seconds;rate;format;bits;state=null;trimmed=!1;trimming=!1;trimmedFrom;trimmedTo;filesize;cleaned_up=!1;constructor(e){Object.keys(e).forEach((t=>{this[t]=e[t]})),e.id||(this.id=`${e.session_id}-${e.side}`)}async getAllFilenames(){let e=Object.keys(n).reduce(((e,t)=>(n[t].map((t=>{t.legacyTemplate&&(e[t.legacyTemplate.replace("%side",this.side)]=!0),e[t.template.replace("%side",this.side)]=!0})),e)),{});return Object.keys(e)}async setActiveState(e){switch(this.state=e,this.post_capturing=!1,this.trimming=!1,e){case"original":this.post_captured=!1,this.trimmed=!1,this.normalized=!1;break;case"post_captured":this.post_captured=!0,this.trimmed=!1,this.trimmedFrom=null,this.trimmedTo=null,this.normalized=!1;break;case"trimmed":this.post_captured=!0,this.trimmed=!0,this.normalized=!1}}async getStateInferred(){return this.state?this.state:this.post_captured||this.trimmed||this.normalized?this.normalized?"normalized":this.trimmed?"trimmed":"post_captured":"original"}async cleanup(){if("normalized"!=this.state)return console.warn("Will not cleanup, not in normalized state. Too risky. Aborting."),!1;let e=["file","reference","waveform"].reduce(((e,t)=>(["original","trimmed"].map((s=>{const i=this.getExistingVariantPath(t,s);i&&e.push(i)})),e)),[]),t=0,s=0;try{const i=[this.file,this.waveform,this.reference];console.log("Cleanup blacklist",i);for(const r of e)i.indexOf(r)>-1||(s++,t+=o.statSync(r).size,console.log(`I would delete ${r}`),o.unlinkSync(r));return this.cleaned_up=!0,{filesDeleted:s,mbDeleted:t?t/1048576:0}}catch(e){throw console.error(`There was an error cleaning up recording: ${e.message}`,e),e}}async setActiveFileState(e){for(const t of variants){const s=this.getExistingVariantPath(t.name,e);s&&(this[t.name]=s)}}async debug(){let e=await this.getStateInferred();return{state:this.state,inferredState:e,activeFilesForState:{file:this.getExistingVariantPath("file",e),reference:this.getExistingVariantPath("reference",e),waveform:this.getExistingVariantPath("waveform",e)}}}audioPath(){return`${a.dataDir}/sessions/${this.session_id}/audio`}nameForVariant(e,t){let s=n[t].find((t=>t.name===e));if(!s)throw new Error(`The variant '${e}' is not a valid variant name`);try{return s.template.replace("%side",this.side)}catch(e){return!1}}pathForVariant(e,t){let s=this.nameForVariant(e,t);return s?`${this.audioPath()}/${s}`:null}getExistingVariantPath(e,t){let s=n[t].find((t=>t.name===e));if(!s)return null;try{let i=[this.nameForVariant(e,t)];s.legacyTemplate&&i.push(s.legacyTemplate.replace("%side",this.side));for(const e of i){let t=`${this.audioPath()}/${e}`;if(this.pathIfExists(t))return t}return null}catch(e){return!1}}pathIfExists(e){try{return r(e)}catch(e){return null}}async getInfoForAudio(e){return new Promise(((t,s)=>{i(`ffprobe ${this[e]}`,((e,i,r)=>{if(e)return s(e.message);if(r){let e={seconds:0,rate:null,format:null,bits:null};const s=/Duration: (\d{2}):(\d{2}):(\d{2}).(\d{1,2}),/gm.exec(r);s&&s[1]&&(e.seconds+=3600*parseInt(s[1]),e.seconds+=60*parseInt(s[2]),e.seconds+=parseInt(s[3]),e.seconds+=parseInt(s[4])/100);const i=/Audio: ([a-z0-9]+),\s?(\d+)\s?Hz/gm.exec(r);i&&i[1]&&(e.format=i[1].trim(),e.rate=parseInt(i[2]));const a=/Audio:.+\((\d+)\sbit\)/gm.exec(r);a&&a[1]&&(e.bits=parseInt(a[1])),t(e)}}))}))}async syncFileInfo(){const e=await this.getInfoForAudio("file");return console.log("Recording.syncFileInfo",e),Object.keys(e).forEach((t=>{this[t]=e[t]})),e}async getInfo(){const e=await this.getInfoForAudio("file");return Object.keys(e).forEach((t=>{this[t]=e[t]})),e}}},1272:(e,t,s)=>{const i=s(5597),r=s(4386),{ValidationError:a}=(s(2353),s(6217),s(5636));let o=["Recording"];e.exports=class extends i{jobState;session;objectType;objectId;state;reportingInterval;constructor(e,t,s,i){if(super(),o.indexOf(t)<0)throw new Error(`Cannot revert ${t}, not supported.`);this.session=e,this.objectType=t,this.objectId=s,this.state=i}getId(){return`Reverter-${this.objectType}-${this.objectId}`}async getJobState(){return this.jobState}getTitle(){return`Reverting ${this.objectType} ${this.objectId} to ${this.state}`}async initJobState(){return this.jobState={object:this.objectType,object_id:this.objectId,data:null,id:this.getId(),title:this.getTitle(),name:"revert",status:"Queued...",state:"queued",completed:!1,progress:!0},this.reportingInterval=setInterval((()=>{r.pub("job",this.jobState)}),3e3),this.jobState}async stop(){return null}async process(){return this.jobState.status="Reverting","Recording"===this.objectType&&await this.validateForRecording(),(async()=>{"Recording"===this.objectType&&await this.processRecording(),await this.session.save()})().then((()=>{this.jobState.state="completed"})).catch((e=>{console.error("Reverter.process() exception",e),this.jobState.state="failed",this.jobState.error=e.message||e})).finally((()=>{this.reportingInterval&&clearInterval(this.reportingInterval),this.jobState.completed=!0,r.pub("job",this.jobState)})),this.jobState}async validateForRecording(){let e=["original","post_captured","trimmed","normalized"];if(e.indexOf(this.state)<0)throw new Error("Not a valid reversion state");let t=await this.session.getRecordingById(this.objectId);if(!t)throw new Error("Not a valid recording id for this session");let s=await t.getStateInferred();if(e.indexOf(this.state)>=e.indexOf(s))throw new a("Cannot revert.",[{state:["Cannot revert to current or forward state."]}])}async processRecording(){let e=await this.session.getRecordingById(this.objectId);if(this.session.normalized=!1,"original"===this.state){let t=e.getExistingVariantPath("file",this.state);t&&(e.file=t,e.reference=null,e.waveform=null,await e.setActiveState("original"))}else if("post_captured"===this.state){let t=e.getExistingVariantPath("file","post_captured");if(t){e.file=t;let s=!0;for(const t of["waveform","reference"]){let i=e.getExistingVariantPath(t,"post_captured");i?e[t]=i:s=!1}s?await e.setActiveState("post_captured"):(e.reference=null,e.waveform=null,await e.setActiveState("original"))}}else if("trimmed"===this.state&&e.getExistingVariantPath("file","trimmed")){let t=!0;for(const s of["waveform","reference"]){let i=e.getExistingVariantPath(s,"trimmed");i?e[s]=i:t=!1}t?await e.setActiveState("trimmed"):(e.reference=null,e.waveform=null,await e.setActiveState("original"))}await e.syncFileInfo(),this.jobState.data={...e},await this.session.ensureRecording(e)}}},6217:(e,t,s)=>{const i=s(2345),r=s(7147),a=s(3619),o=s(1821),n=(s(2123),s(2353)),c=["title","description","manual_artist","manual_album","media_grade","version_reference"];e.exports=class{id;drop_id;id_discogs;title;description;release_version;created_at;updated_at;recordings=[];uploads=[];manual_artist="";manual_album="";media_grade;version_reference;normalizing=!1;normalized=!1;cleaned_up=!1;image;last_artist;last_album;burntable_sync_status;burntable_sync_error;constructor(){}async ensureRecording(e){if(!e.side||!e.session_id)return void console.error("Cannot ensureRecording without required fields");e.id||(e.id=`${e.session_id}-${e.side}`),this.load(this.id);let t=this.recordings.findIndex((t=>t.side===e.side));return t>-1?this.recordings[t]={...e}:this.recordings.push({...e}),await o.addShare(this.getArtist(),this.getAlbum(),e.file),this.save()}ensureUpload(e){this.uploads.push(e)}async create(e){const t=Math.round(Date.now()/1e3);this.id=t;for(const t of c)e.hasOwnProperty(t)&&(this[t]=e[t]);return this.drop_id=null,this.created_at=t,this.updated_at=t,this.save()}getAlbum(){let e;if(this.manual_album)e=this.manual_album;else if(this.release_version&&this.release_version.title)e=this.release_version.title;else{let t=this.title.split("-");e=t[1]?t[0].trim():this.title}let t="";return this.version_reference&&(t=` (${this.version_reference.trim()})`),`${e}${t}`}getArtist(){if(this.manual_artist)return this.manual_artist;if(this.release_version&&this.release_version.artist&&this.release_version.artist.name)return this.release_version.artist.name;let e=this.title.split("-");return e[1]?e[1].trim():"Unknown"}audioDir(){return`${a.dataDir}/sessions/${this.id}/audio`}tracksDir(){return`${a.dataDir}/sessions/${this.id}/audio/tracks`}async removeTracksForSide(e){const t=(await this.getTracksWithFiles()).filter((t=>t.side===e));if(!t)return!0;let s=[];for(const e of t)s.push(...e.filenames);for(const t of s){try{let e=`${this.tracksDir()}/${t}`;r.existsSync(e)&&r.unlinkSync(e),await o.removeShareByArtistAlbum(this.getArtist(),this.getAlbum(),t)}catch(t){console.error(`Failed to remove track for side ${e}`)}await o.cleanupEmptyShareDir(this.getArtist(),this.getAlbum())}}async rebuildAllShares(){return this.last_artist&&this.last_album||(this.last_artist=this.getArtist(),this.last_album=this.getAlbum()),await this.removeAllShares(this.last_artist,this.last_album),await this.addAllShares(this.last_artist,this.last_album),this.save()}async removeAllShares(e,t){return console.log(`share: remove all shares for ${e} ${t}`),await o.removeAllSharesByArtistAlbum(e,t),await o.cleanupEmptyShareDir(e,t),!0}async addAllSharesForCurrentAlbumArtist(){return this.addAllShares(this.getArtist(),this.getAlbum())}async addAllShares(e,t){let s=[],i=await this.getTracksWithFiles();if(i.length>0&&i.map((e=>{s.push(...e.filenames.map((e=>`${this.tracksDir()}/${e}`)))})),this.recordings&&this.recordings.length>0&&this.recordings.map((e=>{s.push(e.file)})),0===s.length)return!1;for(const i of s)await o.addShare(e,t,i);return!0}async cleanup(){let e=-1,t=0,s=0;for(const i of this.recordings){e++;const r=new n(i);if("normalized"!=r.state){console.warn(`Skipping cleanup on ${this.title} side ${r.side}, not normalized.`);continue}const{filesDeleted:a,mbDeleted:o}=await r.cleanup();t+=a,s+=o,this.recordings[e]={...r}}return this.cleaned_up=!0,await this.save(),{totalMbDeleted:s,totalFilesDeleted:t}}async update(e){if(!this.id)throw new Error("Cannot update without id");for(const t of c)e.hasOwnProperty(t)&&(this[t]=e[t]);return this.save()}updateReleaseVersion(e){return this.release_version=e,this.id_discogs=e.id,i.put(`sessions.${this.id}.release_version`,e),this.save()}load(e){let t=this;const s=i.get(`sessions.${e}.session`);if(!s)throw new Error(`Invalid session id ${e}`);Object.keys(s).forEach((e=>{t[e]=s[e]})),t.recordings.forEach((e=>{e.id||(e.id=`${e.session_id}-${e.side}`)}))}async save(){return this.last_artist==this.getArtist()&&this.last_album==this.getAlbum()||(console.debug("Changing artist/album name, rebuilding all shares"),await this.removeAllShares(this.last_artist,this.last_album),await this.addAllShares(this.getArtist(),this.getAlbum())),this.last_artist=this.getArtist(),this.last_album=this.getAlbum(),await i.lockPut(`sessions.${this.id}.session`,{...this}),this.toJSON()}async deleteSide(e){this.load(this.id);let t=this.recordings.findIndex((t=>t.side===e));if(t<0)return!1;let s=new n(this.recordings[t]),i=await s.getAllFilenames(),a=this.audioDir(),o=i.map((e=>`${a}/${e}`));for(const e of o)try{r.unlinkSync(e),console.log(`Session.deleteSide() deleted ${e}`)}catch(e){}try{return this.recordings.splice(t,1),await this.save(),!0}catch(e){return console.error(e),!1}}async getRecording(e){let t=this.recordings.findIndex((t=>t.side===e));if(t<0)throw new Error("No side found.");return new n(this.recordings[t])}async getRecordingBySide(e){return this.getRecording(e)}async getRecordingById(e){let t=this.recordings.findIndex((t=>(t.id||(t.id=`${t.session_id}-${t.side}`),t.id===e)));if(t<0)throw new Error("No side found.");return new n(this.recordings[t])}getSessionDir(){return`${a.dataDir}/sessions/${this.id}`}async updateImage(e){try{console.log("Session.updateImage() initializing sharp");const t=s(7441);let i=`${this.getSessionDir()}/image.jpg`;console.log("Session.updateImage() running sharp"),await t(e).resize(1200,1200).jpeg({quality:70}).toFile(i),console.log("Session.updateImage() succeeded"),this.image=i,await this.save()}catch(e){console.error(`Session.updateImage() failed to create image: ${e.message}`)}}async getTracksWithFiles(){let e=await this.getTracks();return e&&0!==e.length?e.filter((e=>!!e.filenames)):[]}async getTracks(){let e=`sessions.${this.id}.tracks`,t=i.get(e,[]),s={};try{s=r.readdirSync(`${this.tracksDir()}`,{withFileTypes:!0}).filter((e=>!e.isDirectory())).reduce(((e,t)=>{const s=t.name;let i=s.match(/^([A-Z])(\d)-.+/);return i&&i[2]?(e[`${i[1]}${i[2]}`]||(e[`${i[1]}${i[2]}`]=[]),e[`${i[1]}${i[2]}`].push(s),e):e}),{})}catch(e){}return t=t.map((e=>{const t=`${e.side}${e.position}`;return e.filenames=s[t],e})),t}async ensureTracksForSession(e){let t=`sessions.${this.id}.tracks`,s=i.get(t,[]);Array.isArray(s)||(s=[]),Array.isArray(e)||(e=[e]);for(const t of e){let e=s.findIndex((e=>e.side===t.side&&e.position===t.position));e>-1?s.splice(e,1,t):s.push(t)}return s.sort(((e,t)=>e.sequence&&t.sequence?e.sequence>t.sequence:e.side===t.side?e.position>t.position:e.side>t.side)),await i.lockPut(t,s),s}async removeTrackForSession(e){let t=`sessions.${this.id}.tracks`,s=i.get(t,[]),r=s.findIndex((t=>t.side===e.side&&t.position===e.position));if(r<0)return!1;s.splice(r,1),await i.lockPut(t,s)}toJSON(){return{...this}}}},4839:(e,t,s)=>{const i=s(5597),r=s(4386),a=s(7147),{ValidationError:o}=s(5636),n=s(2123),c=(s(8370),s(3619),s(3489)),{spawn:l}=s(2081);e.exports=class extends i{session;side;recording;tracks;outputFormatDef;tracksDir;sideTracks=[];sideTracksKB={};splitProc;coverProc;outputFiles=[];reportInterval;jobState;constructor(e,t){super(),this.session=e,this.side=t}getId(){return this.recording?`Splitter-${this.recording.id}`:null}getTitle(){return this.recording&&this.session?`Splitting ${this.session.title} Side ${this.recording.side}`:null}async initJobState(){this.recording=await this.session.getRecordingBySide(this.side),this.jobState={object:"Recording",object_id:this.recording.id,data:{...this.recording},id:this.getId(),title:`Generating tracks for ${this.session.title} Side ${this.recording.side}`,name:"splitter",status:"Queued",state:"queued",error:null,completed:!1,progress:!0},this.reportInterval=setInterval((()=>{this.jobState.data={...this.recording},r.pub("job",this.jobState)}),3e3)}async getJobState(){return this.jobState}async stop(){await this.killProcesses([this.splitProc,this.coverProc]),await this.removeFiles(this.outputFiles),this.reportInterval&&clearInterval(this.reportInterval),this.jobState.error="Manually stopped",this.jobState.state="stopped",r.pub("job",this.jobState)}debug(e,t){console.log(`Splitter: ${e}`,t)}async process(){if(this.jobState.state="running",this.tracksDir=this.session.tracksDir(),a.existsSync(this.tracksDir)||(this.debug(`Creating tracks dir ${this.tracksDir}`),a.mkdirSync(this.tracksDir,{recursive:!0})),this.recording=await this.session.getRecordingBySide(this.side),this.tracks=await this.session.getTracks(),this.sideTracks=this.tracks.filter((e=>e.side===this.side)),!this.sideTracks||0===this.sideTracks.length)throw new o("There are no tracks.",{tracks:["At least one track is required"]});try{r.pub("job",this.jobState);try{await this.session.removeTracksForSide(this.side)}catch(e){console.error("Failed to removeTracksForSide",e)}return this.splitRecording().then((async e=>{if(this.session.image)try{for(const e of this.sideTracks)await this.applyCoverImage(e)}catch(e){console.error("Failed to apply cover image",e)}try{await this.session.addAllSharesForCurrentAlbumArtist()}catch(e){console.warn(`Failed to add all shares ${e.message}`)}this.jobState.state="completed",r.pub("store",{name:"session",data:{...this.session}})})).catch((e=>{this.jobState.error=`Error splitting: ${e.message}`,this.jobState.state="failed"})).finally((()=>{this.reportInterval&&clearInterval(this.reportInterval),this.jobState.completed=!0,r.pub("job",this.jobState)})),this.jobState}catch(e){console.error("SPLITTER ERROR",e),this.jobState.error=`Error splitting: ${e.message}`,this.jobState.completed=!0,r.pub("job",this.jobState),this.reportInterval&&clearInterval(this.reportInterval)}}async splitRecording(){this.jobState.status="Splitting into track outputs";let e={"aac-48-256":{cmd:["-ar","48000","-c:a","aac","-b:a","256k"],ext:"m4a"},"aac-48-320":{cmd:["-ar","48000","-c:a","aac","-b:a","320k"],ext:"m4a"},"vorbis-48-q10":{cmd:["-ar","48000","-c:a","libvorbis","-q:a","10"],ext:"ogg"},"vorbis-48-q6":{cmd:["-ar","48000","-c:a","libvorbis","-q:a","6"],ext:"ogg"},"mp3-48-192":{cmd:["-ar","48000","-c:a","libmp3lame","-q:a","1"],ext:"mp3"},"mp3-48-256":{cmd:["-ar","48000","-c:a","libmp3lame","-q:a","0"],ext:"mp3"},"flac-48":{cmd:["-ar","48000","-c:a","flac"],ext:"flac"}},t=c.get("outputFormat");t&&e[t]||(console.log(`No output settings for ${t}, falling back to mp3-48-192`),t="mp3-48-256"),this.outputFormatDef=e[t];let s=t.split("-")[0];console.log(`Splitter.splitRecording() ${t} with ${s} encoder`);let i=["-y","-hide_banner","-i",this.recording.file];return this.sideTracks=this.sideTracks.map(((e,t)=>{const s=`${e.side}${e.position}`;e.idx=t,e.file=`${this.tracksDir}/${s}-${n.validFilename(e.title)}.${this.outputFormatDef.ext}`,e.meta=this.metaForTrack(e),this.outputFiles.push(e.file),i.push("-ss",`${e.offset}s`),e.position!==this.sideTracks.length&&this.sideTracks[t+1]&&i.push("-to",`${this.sideTracks[t+1].offset}s`),i.push(...this.outputFormatDef.cmd);for(const t in e.meta)e.meta[t]&&i.push("-metadata",`${t}=${e.meta[t]}`);return i.push(e.file),e})),new Promise(((e,t)=>{this.splitProc=l("ffmpeg",i),this.splitProc.on("close",(e=>{this.debug("splitProc on close"),0===e||t(`Exited with code ${e} while splitting file`)})).on("exit",(async()=>{for(const e of this.sideTracks)if(!a.existsSync(e.file))return t("Failed to split audio");e(!0)})).on("error",(function(e){try{t(e)}catch(e){console.error(e)}})),this.splitProc.stderr.on("data",(function(e){e&&console.log("Splitter.splitRecording.stderr",e.toString())})),this.splitProc.stdout.on("data",(function(e){e&&console.log("Splitter.splitRecording.stdout",e.toString())}))}))}metaForTrack(e){let t={artist:"Unknown",title:"Unknown",album:"Unknown",track:"Unknown"};return t.album=this.session.getAlbum(),t.artist=this.session.getArtist(),e.discogs_track&&e.discogs_track.artist&&e.discogs_track.artist.artist_name&&(this.debug(`Apply discogs track artist override: ${e.discogs_track.artist.artist_name}`),t.artist=e.discogs_track.artist.artist_name),e.artist&&(this.debug(`Apply manual track artist override: ${e.artist}`),t.artist=e.artist),e.sequence?t.track=e.sequence:e.discogs_track.sequence&&(t.track=e.discogs_track.sequence),e.title&&(t.title=e.title),t}async applyCoverImage(e){const t=e.file;let s=[];const i=this.session.image,r=this.outputFormatDef.ext;let o,n;return["ogg"].indexOf(r)>-1?(n="ffmpeg",o=`${t}.temp.${r}`,this.outputFiles.push(o),s.push("-hide_banner","-y","-i",t,"-i",i,o)):["flac"].indexOf(r)>-1?(n="metaflac",s=[],e.meta.title&&s.push("--remove-tag=TITLE",`--set-tag=TITLE=${e.meta.title}`),e.meta.album&&s.push("--remove-tag=ALBUM",`--set-tag=ALBUM=${e.meta.album}`),e.meta.artist&&s.push("--remove-tag=ARTIST",`--set-tag=ARTIST=${e.meta.artist}`),s.push(`--import-picture-from=${i}`,t)):["m4a"].indexOf(r)>-1?(n="mp4art",s.push("--add",i,t)):(n="ffmpeg",o=`${t}.temp.${r}`,this.outputFiles.push(o),s.push("-hide_banner","-y","-i",t,"-i",i,"-map","0:0","-map","1:0","-c","copy","-id3v2_version","3","-metadata:s:v",'title="Album cover"',"-metadata:s:v",'comment="Cover (front)"',o)),this.debug(s.join(" ")),new Promise(((e,i)=>{this.coverProc=l(n,s),this.coverProc.on("close",(e=>{this.debug("coverProc on close"),0===e||i(`Exited with code ${e} while splitting file`)})).on("exit",(()=>{if(o){if(!a.existsSync(o))return i("Failed to generate output file");a.renameSync(o,t)}e(!0)})).on("error",(function(e){try{i(e)}catch(e){console.error(e)}})),this.coverProc.stderr.on("data",(function(e){e&&console.log("Splitter.applyCoverImage.stderr",e.toString())})),this.coverProc.stdout.on("data",(function(e){e&&console.log("Splitter.applyCoverImage.stdout",e.toString())}))}))}}},4408:(e,t,s)=>{const{EventEmitter:i}=s(1239),r=s(7147),a=s(2353),o=s(3361),n=s(4525),c=s(4386),l=s(3619),d=s(3489),p=s(1041),{exec:u,execSync:h,spawn:g}=s(2081),m=s(4610);e.exports=new class extends i{duration;jack_capture;flacFile;levelReportingInterval;secondsReportingInterval;ledInterval;waveFormSourceFile;jackManager;preferredSampleRate;preferredFormat;preferredAutoStopSeconds;session;side;seconds;report=!1;constructor(){super(),this.jackManager=o}async record(e,t){let s=this;if(this.preferredFormat=d.get("captureFormat"),this.preferredSampleRate=1e3*d.get("captureSampleRate"),this.preferredAutoStopSeconds=d.get("captureAutoStopSeconds"),console.log(`Transport.record() will stop in ${this.preferredAutoStopSeconds} seconds`),this.jack_capture)return void console.log("Transport jack_capture already exists. Aborting.");try{await this.jackManager.ensure(this.preferredSampleRate,!0),console.log(`Transport.record() jackd is running at ${this.preferredSampleRate} will stop automatically in ${this.preferredAutoStopSeconds} seconds.`),await m.sleep(350)}catch(e){throw new Error(`Could not ensure jack: ${e.message}`)}if(this.seconds=0,!e||!e.id)throw new Error("There is no session id");if(!t)throw new Error("There is no side (like A, B, C, D, etc...)");this.side=t,this.session=e;let i=d.get("captureFormat");console.log("Transport preferences captureFormat",i);let a="alac"===i?"alac":"flac",o=`${l.dataDir}/sessions/${this.session.id}/audio`;r.existsSync(o)||r.mkdirSync(o,{recursive:!0}),this.flacFile=`${o}/${t}.original.${a}`;let n=`-c 2 -p system:capture* -f ${i} --hide-buffer-usage --silent --meterbridge -fn ${this.flacFile}`;console.log(`jack_capture ${n}`),this.jack_capture=g("jack_capture",n.split(" ")),this.jack_capture.on("exit",(function(e,t){s.jack_capture=null,console.error(`jack_capture exited with code ${e} and signal ${t}`),s.emit("exit",`jack_capture exited with code ${e} and signal ${t}`)})),this.jack_capture.on("close",(function(e,t){s.jack_capture=null,s.secondsReportingInterval&&clearInterval(s.secondsReportingInterval),s.levelReportingInterval&&clearInterval(s.levelReportingInterval),console.error(`jack_capture closed with code ${e} and signal ${t}`),s.emit("close",`jack_capture closed with code ${e} and signal ${t}`)})),this.jack_capture.on("error",(function(e){try{this.emit("error",e)}catch(e){console.error(e)}})),this.jack_capture.stderr.on("data",(function(e){try{this.emit("stderr",e.toString())}catch(e){console.error(`Transport.record() jack_capture error: ${e.message}`)}})),this.report=!1;let p=null;this.levelReportingInterval=setInterval((()=>{this.report=!0}),100);let u=!1;this.jack_capture.stdout.on("data",(e=>{if(u||(this.startReportingSeconds(),this.startLedRotation(),u=!0),!this.report)return;const t=e.toString().split(/[/\r\n]/);if(!t||!t[0]||!t[1])return;this.report=!1;const i=[s.extractLevelsFromBfrPart(t[0]),s.extractLevelsFromBfrPart(t[1])];if(0===i[0]||0===i[1])return s.emit("levels",p),void c.pub("levels",p);p=i,s.emit("levels",i),c.pub("levels",i)}))}startReportingSeconds(){this.seconds=0,this.secondsReportingInterval=setInterval((()=>{if(this.seconds++,this.seconds>this.preferredAutoStopSeconds)return console.log(`Transport hit autoStop ${this.preferredAutoStopSeconds} seconds`),void this.stop().then((()=>{console.log("Stop complete via autoStop")}));const e={side:this.side,offset:this.seconds,session_id:this.session.id,session:{...this.session}};c.pub("store",{name:"capture",data:e}),c.pub("store",{name:"session",data:{...this.session}})}),1e3)}startLedRotation(){n.startTransportRotation(900).then((()=>{console.log("Rotation started")}))}extractLevelsFromBfrPart(e){const t=/(\d{2}):\|(\-+)\s+?\*?\s+\|$/g.exec(e);return t&&t[2]?t[2].length:0}async stop(){if(this.levelReportingInterval&&clearInterval(this.levelReportingInterval),this.secondsReportingInterval&&clearInterval(this.secondsReportingInterval),n.setAllLeds(!1).then((()=>{})),n.flashAll(3,500).then((()=>{})),this.report=!1,this.jack_capture&&this.jack_capture.pid){try{console.log(`Killing jack capture ${this.jack_capture.pid}`),p(this.jack_capture.pid),this.jack_capture=null,await this.jackManager.adcSleep()}catch(e){console.error(`Transport.stop() encountered error killing jack_capture: ${e.message}`)}await n.stopTransportRotation();try{console.log("Transport.stop()");let e=new a({id:`${this.session.id}-${this.side}`,created_at:Math.round(Date.now()/1e3),session_id:this.session.id,file:this.flacFile,post_captured:!1,waveform:null,reference:null,side:this.side,rate:this.preferredSampleRate,format:this.preferredFormat,state:"original"});return await e.syncFileInfo(),console.log("stop() ensuring recording and saving session..."),await this.session.ensureRecording(e),console.log("Transport.stop() publish null capture"),c.pub("store",{name:"capture",data:null}),c.pub("store",{name:"session",data:{...this.session}}),console.log("Transport.stop() returning recording"),e}catch(e){return c.pub("store",{name:"capture",data:null}),console.error(`>>>>> EXCEPTION <<<<< Transport.stop() exception: ${e.message}`,e),{waveform:null,error:e.message}}}else console.log("Transport: received stop() but I was not recording")}isRecording(){return null!=this.jack_capture}filename(){}}},53:(e,t,s)=>{const i=s(4386),r=s(7147),a=(s(8370),s(5597)),{spawn:o}=(s(3619),s(3489),s(1041),s(2081)),n=s(7441);e.exports=class extends a{trimming=!1;trimProc;trimReferenceProc;trimFileOutput;trimWaveformOutput;tmpReference;session;side;recording;from;to;reportInterval;jobState;constructor(e,t,s,i){super(),this.session=e,this.side=t,this.from=s,this.to=i}async initJobState(){return this.recording||(this.recording=await this.session.getRecording(this.side)),this.jobState={object:"Recording",object_id:this.recording.id,data:{...this.recording},id:this.getId(),title:`Trimming ${this.session.title} Side ${this.recording.side}`,name:"trim",status:"Queued",error:null,state:"queued",progress:!0},this.reportInterval=setInterval((()=>{this.jobState.data={...this.recording},i.pub("job",this.jobState)}),3e3),this.jobState}async getJobState(){return this.jobState}getId(){return this.recording?`Trimmer-${this.recording.id}`:null}getTitle(){return this.recording&&this.session?`Trimming ${this.session.title} Side ${this.recording.side}`:null}async stop(){return await this.killProcesses([this.trimReferenceProc,this.trimProc]),await this.removeFiles([this.trimFileOutput,this.trimWaveformOutput,this.tmpReference]),this.recording.trimming=!1,this.recording.trimmedFrom=null,this.recording.trimmedTo=null,this.reportInterval&&clearInterval(this.reportInterval),this.jobState.state="stopped",this.jobState.error="Manually stopped",i.pub("job",this.jobState),this.session.ensureRecording(this.recording)}async process(){this.recording=await this.session.getRecording(this.side),this.recording.trimming=!0,this.recording.trimmedFrom=this.from,this.recording.trimmedTo=this.to,await this.session.ensureRecording(this.recording),this.jobState.status="Trimming audio",this.jobState.state="running";try{return i.pub("job",this.jobState),Promise.all([this.trimFile(),this.trimReference(),this.trimWaveform()]).then((async e=>{this.reportInterval&&clearInterval(this.reportInterval),this.jobState.state="completed",this.jobState.completed=!0,i.pub("job",this.jobState),this.recording.trimmed=!0,this.recording.state="trimmed",this.recording.trimming=!1,this.recording.file=e[0],this.recording.reference=e[1],this.recording.waveform=e[2],await this.recording.syncFileInfo(),await this.session.ensureRecording(this.recording),i.pub("store",{name:"session",data:{...this.session}}),this.trimming=!1})).catch((e=>{console.log("Trimmer.trim ERROR: ",e)})),this.jobState}catch(e){return console.error("TRIMMER ERROR",e),this.jobState.completed=!0,this.jobState.state="failed",this.jobState.error=`Error trimming: ${e.message}`,i.pub("job",this.jobState),this.jobState}}async trimFile(){this.trimFileOutput=this.recording.pathForVariant("file","trimmed");const e=`-y -i ${this.recording.file} -ss ${this.from}s -to ${this.to}s ${this.trimFileOutput}`;return console.log(`Trimmer.trimFile(): ffmpeg ${e}`),new Promise(((t,s)=>{this.trimProc=o("ffmpeg",e.split(" ")),this.trimProc.on("close",(e=>{0===e?t(this.trimFileOutput):s(`Exited with code ${e} while trimming file`)})).on("error",(function(e){try{s(e)}catch(e){console.error(e)}}))}))}async trimReference(){this.referenceOutput=this.recording.pathForVariant("reference","trimmed"),this.tmpReference=this.recording.reference.replace(/\.[^/.]+$/,".t.mp3");const e=`-f ${this.recording.reference} ${this.mp3spltTime(this.from)} ${this.mp3spltTime(this.to)} -o @f.t`;return console.log(`Trimmer.trimReference(): mp3splt ${e}`),new Promise(((t,s)=>{this.trimReferenceProc=o("mp3splt",e.split(" ")),this.trimReferenceProc.on("close",(e=>{0===e?(console.log(`${this.tmpReference} >> ${this.referenceOutput}`),r.renameSync(this.tmpReference,this.referenceOutput),t(this.referenceOutput)):s(`Exited with code ${e} while trimming file`)})).on("error",(function(e){try{s(e)}catch(e){console.error(e)}}))}))}mp3spltTime(e){return`${Math.floor(e/60)}.${(e%60).toFixed(2)}`}async trimWaveform(){this.trimWaveformOutput=this.recording.pathForVariant("waveform","trimmed");const{width:e,height:t}=await n(this.recording.waveform).metadata(),s=this.from/this.recording.seconds*e,i=e-this.to/this.recording.seconds*e;return await n(this.recording.waveform).extract({left:Math.floor(s),top:0,width:Math.floor(e-(s+i)),height:t}).toFile(this.trimWaveformOutput,(function(e){})),this.trimWaveformOutput}}},3619:(e,t,s)=>{s(5142).config();const{resolve:i}=s(1017);process.env.DATA_DIR||(console.error('CANNOT RUN WITHOUT "DATA_DIR=" IN ENV'),process.exit());const r=process.env.DATA_DIR;e.exports={build:20,versionName:"20.0",rootDataDir:r,dataDir:`${r}/data`,shareDir:`${r}/shared`,btHome:process.env.BT_HOME,dsApiPort:process.env.DS_API_PORT,dataIsMount:process.env.DATA_IS_MOUNT,driver:process.env.DRIVER?process.env.DRIVER:"JUNE"}},2345:(e,t,s)=>{const i=s(1017),r=s(7147),a=s(3619);let o={};function n(e,t){let s=function(e){return a.dataDir+"/"+e.split(".").join("/")+".json"}(e);Array.isArray(t)||(t={...t});let o=JSON.stringify(t,null,"\t");const n=i.dirname(s);return r.existsSync(n)||r.mkdirSync(n,{recursive:!0}),r.writeFileSync(s,o),!0}e.exports={get:function(e,t){let s=a.dataDir+"/"+e.split(".").join("/")+".json";if(!r.existsSync(s))return t||null;let i=r.readFileSync(s);return JSON.parse(i.toString("utf-8"))},put:n,lockPut:async function e(t,s){return new Promise(((i,r)=>{if(o[t]){if(o[t]>10)return console.warn("Data warning: failed to acquire lock"),r(`Failed to acquire lock for ${t}`);console.warn(`Data key ${t} locked, waiting 50ms.`),setTimeout((async()=>{o[t]++,await e(t,s)&&i(!0)}),50)}o[t]=1,n(t,s),delete o[t],i(!0)}))}}},4913:(e,t,s)=>{s(3619);const i=process.env.DRIVER?process.env.DRIVER:"JUNE";e.exports=new class{driver;initialized=!1;constructor(){"JUNE"===i?this.driver=s(7931):"SOQ2023"===i&&(this.driver=s(2650))}async init(){if(this.initialized)console.log("Driver already initialized");else{console.log(`Initializing ${i}`);try{await this.driver.init()}catch(e){console.error(`Error on driver init: ${e.message}`)}console.log(`Driver ${i} initialized`),this.initialized=!0}}async state(){return this.driver.state()}async getCPUTemp(){return this.driver.getCPUTemp()}async getCards(){return this.driver.getCards()}async sleep(){return this.driver.sleep()}async changeSampleRate(e){return this.driver.changeSampleRate(e)}async setLED(e,t){return this.driver.setLED(e,t)}async setBypassRelay(e){return this.driver.setBypassRelay(e)}async getBypassRelayState(){return this.driver.getBypassRelayState()}async setDACMute(e){return this.driver.setDACMute(e)}async getDACMute(){return this.driver.getDACMute()}async onButtonState(e){return this.driver.onButtonState(e)}}},7931:(e,t,s)=>{const{exec:i,execSync:r,spawn:a}=s(2081),o=s(2544),n=o.promise,c={1:25,2:24,3:23},l={48e3:{m0:"dl",m1:"dl"},96e3:{m0:"dh",m1:"dl"},192e3:{m0:"dl",m1:"dh"}};e.exports=new class{dacMuted=!1;bypassRelay=!1;lastButtonValue=!0;constructor(){}async init(){o.setMode(o.MODE_BCM),await n.setup(5,n.DIR_IN,n.EDGE_NONE),await n.setup(17,n.DIR_IN,n.EDGE_NONE),await n.setup(3,n.DIR_IN,n.EDGE_BOTH),i("raspi-gpio set 13 op pn dl"),i("raspi-gpio set 6 op pn dh"),i("raspi-gpio set 26 pd && raspi-gpio set op pn dh"),i("raspi-gpio set 5 op pn dh"),i("raspi-gpio set 17 op pn dh"),i("raspi-gpio set 12 pu")}async getCards(){return{capture:"hw:CARD=GenericStereoAu,DEV=1",playback:"hw:CARD=GenericStereoAu,DEV=0"}}async getCPUTemp(){try{return r("vcgencmd measure_temp").toString()}catch(e){return"Unknown, error"}}async state(){return[{name:"mute",value:await this.getGpioState(5)},{name:"relay",value:await this.getGpioState(17)}]}async setLED(e,t){c[e]&&r(`raspi-gpio set ${c[e]} op pn ${t?"dh":"dl"}`)}async setBypassRelay(e){r("raspi-gpio set 17 op pn "+(e?"dh":"dl"))}async getBypassRelayState(){return this.getGpioState(17)}async getDACMute(){return this.dacMuted}async setDACMute(e){this.dacMuted!==e&&(this.dacMuted=e,r(e?"raspi-gpio set 5 op pn dl":"raspi-gpio set 5 op pn dh"))}async sleep(){console.log("JUNE: sleep()"),r("raspi-gpio set 26 op pn dl")}async changeSampleRate(e){r("raspi-gpio set 5 op pn dl"),r("raspi-gpio set 26 op pn dl"),r(`raspi-gpio set 6 op pn ${l[e].m0} && raspi-gpio set 13 op pn ${l[e].m1}`),r("raspi-gpio set 26 op pn dh"),r("raspi-gpio set 5 op pn dh")}async onButtonState(e){n.on("change",(function(t,s){this.lastButtonValue!==s&&(this.lastButtonValue=s,e(!1===s))}))}async getGpioState(e){return n.read(e)}}},2650:(e,t,s)=>{const{exec:i,execSync:r,spawn:a}=s(2081),{bitmagic:o}=s(3786),n=s(3846),c=s(2408),l=s(7147),d=s(4610);let p={1:!1,2:!1,3:!1};const u={1:126,2:125,3:123};e.exports=new class{dacMuted=!1;lastSampleRate=96e3;async init(){await this.cmd("cd /sys/class/gpio && echo 133 > export && echo out > gpio133/direction && echo 123 > export && echo out > gpio123/direction && echo 125 > export && echo out > gpio125/direction",!0),await this.cmd("find -L /sys/class/gpio/ -maxdepth 3 -exec chown root:gpio {} \\; -exec chmod 770 {} \\; || true",!0),l.existsSync("/sys/class/gpio/gpio126")?console.log("SOQ2023 LED 1 gpio already initialized"):(console.log("SOQ2023 init LED 1 gpio"),await this.cmd("cd /sys/class/gpio && echo 126 > export && echo out > gpio126/direction",!0)),console.log("SOQ2023 init assigning gpio permissions"),await this.cmd("find -L /sys/class/gpio/ -maxdepth 3 -exec chown root:gpio {} \\; -exec chmod 770 {} \\; || true",!0),await this.initADC(),await this.initDAC()}async state(){return[{name:"relay",value:await this.getBypassRelayState()},{name:"mute",value:await this.getDACMute()}]}async getCPUTemp(){try{return r("cat /sys/class/thermal/thermal_zone0/temp | echo Zone 0: `awk '{print int($1/1000)}'`").toString()}catch(e){return"Unknown, error"}}async getCards(){return{capture:"hw:CARD=GenericI2S,DEV=0",playback:"hw:CARD=GenericI2S,DEV=1"}}async changeSampleRate(e){if(this.lastSampleRate!==e)return this.lastSampleRate=e,console.log("SOQ2023.changeSampleRate full reset?"),this.initADC();console.log("SOQ2023.changeSampleRate sample rate already set")}async sleep(){return console.log("Driver: SOQ2023 ignoring sleep() for now"),!0}async setLED(e,t){if(u[e]){if(p[e]!==t)return p[e]=t,this.cmd(`echo ${t?1:0} > /sys/class/gpio/gpio${u[e]}/value`)}else console.warn(`Driver: there is no led ${e}`)}async setBypassRelay(e){return this.cmd(`echo ${e?1:0} > /sys/class/gpio/gpio133/value`,!0)}async getBypassRelayState(){try{await d.sleep(100);const{stdout:e,stderr:t}=await this.cmd("cat /sys/class/gpio/gpio133/value");return!!(e&&e.indexOf("1")>-1)}catch(e){return console.error("Driver failed to read bypass relay state"),!1}}async getDACMute(){return this.dacMuted}async setDACMute(e){this.dacMuted=e;const t=new n(2,77);e?await t.i2cWriteByte(3,o("b[00010001]").d):await t.i2cWriteByte(3,o("b[00000000]").d),await t.close()}async onButtonState(e){const t=new c("/dev/input/event0");let s=!1;const i=new c.Keyboard(t);i.on("keyup",(t=>{if(0===t.value&&116===t.code){if(!0===s)return;s=!0,e(!0)}})),i.on("keypress",(t=>{if(1===t.value&&116===t.code){if(!1===s)return;s=!1,e(!1)}}))}async cmd(e,t){return new Promise(((s,r)=>{t&&(e=`echo "${e.replace('"','\\"')}" | sudo su`),i(e,((t,i,r)=>{if(null!==t)return console.error(`SOQ2023.cmd exception for ${e}`,t.message),s(t);s({stdout:i,stderr:r})}))}))}async initADC(){const e=new n(2,76);await d.sleep(250),await e.i2cWriteByte(2,145),await e.i2cWriteByte(19,o("b[10000]d[7,3]").d),await e.i2cWriteByte(20,o("d[5,4]d[4,4]").d),await e.i2cWriteByte(33,160),await e.i2cWriteByte(7,135),await e.i2cWriteByte(11,o("b[00]d[32,6]").d),await e.i2cWriteByte(12,o("b[00]d[32,6]").d),await e.i2cWriteByte(13,o("b[00]d[0,6]").d),await e.i2cWriteByte(14,o("b[00]d[0,6]").d),await e.i2cWriteByte(61,o("d[0,6]b[00]").d),await e.i2cWriteByte(66,o("d[0,6]b[00]").d),await e.i2cWriteByte(71,o("d[0,6]b[00]").d),await e.i2cWriteByte(76,o("d[0,6]b[00]").d),await e.i2cWriteByte(107,4);let t=o("d[1]d[1,2]b[1]d[2,2]b[00]").d;await e.i2cWriteByte(60,t),await e.i2cWriteByte(65,t),await e.i2cWriteByte(70,t),await e.i2cWriteByte(75,t),await e.i2cWriteByte(118,o("b[11110000]").d),await e.i2cWriteByte(115,o("b[11110000]").d),await e.i2cWriteByte(116,o("b[11110000]").d),await e.i2cWriteByte(117,o("b[01100000]").d),await e.close()}async initDAC(){const e=new n(2,77);await e.i2cWriteByte(2,16),await e.i2cWriteByte(1,17),await e.i2cWriteByte(2,0),await e.i2cWriteByte(13,o("b[00000000]").d),await e.i2cWriteByte(14,o("b[00000000]").d),await e.i2cWriteByte(14,o("b[00000010]").d),await e.i2cWriteByte(37,o("b[01111101]").d),await e.i2cWriteByte(40,o("b[00000011]").d),await e.i2cWriteByte(61,o("b[00110000]").d),await e.i2cWriteByte(62,o("b[00110000]").d),await e.i2cWriteByte(65,0),await e.i2cWriteByte(2,0),await e.close()}}},6737:(e,t,s)=>{const{exec:i,execSync:r,spawn:a}=s(2081),o=s(3619),n=s(4306),c=s(3361),l=s(4913);async function d(){let e=await l.state();return console.log("lib/dropstation driver state",e),e}async function p(e){return new Promise(((t,s)=>{i(e,((e,s,i)=>{if(null!==e)return t(e);t({stdout:s,stderr:i})}))}))}e.exports={index:d,update:async function(e){console.log("UPDATE",e);for(const t of Object.keys(e))"relay"===t?await l.setBypassRelay(e[t]):"mute"===t&&await l.setDACMute(e[t]);return d()},debug:async function(){return{config:{dsid:await n.get(),driver:o.driver,dataIsMount:o.dataIsMount,build:o.build,versionName:o.versionName},lsblk:await p("lsblk"),df:await p("df -h"),ds:await p("journalctl -q -n 50 --no-pager -u ds"),wifi:await p("nmcli -f IN-USE,SIGNAL,SSID device wifi"),"usb-devices":await p("usb-devices"),cpu:await l.getCPUTemp(),mem:await p("free --mega")}},dumpCommand:p,getSoftwareMonitorState:async function(){return c.getSoftwareMonitorState()},setSoftwareMonitorState:async function(e){return c.setSoftwareMonitorState(e)}}},4306:(e,t,s)=>{s(2081).exec,s(7147),s(3619),e.exports={get:async function(){return process.env.PORTAL_SSID}}},5636:e=>{class t extends Error{errors;constructor(e,t){super(e),this.name="ValidationError",this.errors=t}}e.exports={ValidationError:t}},8370:(e,t,s)=>{const i=s(7147),r=s(3619),a=s(4386);let o=[];const n=`${r.dataDir}/job.log`;let c=!1,l={};async function d(){a.sub("job",(async e=>{if(["queued","running"].indexOf(e.state)<0){console.log(`Logging ${e.id} ${e.state} job state`);const t=o.findIndex((t=>t.id===e.id));t>-1&&(console.log(`Removing ${e.id} from JOBS`),l[e.id]&&delete l[e.id],o.splice(t,1)),await async function(){if(console.log("JobManager.runQueuedJobs() getting open slot count."),0!==await p())for(const e of o){const t=await e.instance.getJobState();"queued"===t.state&&(l[t.id]?console.log(`JobManager.runQueuedJobs() has already QUEUED ${t.id}.`):(l[t.id]=!0,console.log(`JobManager.runQueuedJobs() is processing queued job ${t.id}.`),await e.instance.process(),delete l[t.id]))}else console.log("JobManager.runQueuedJobs() has no available slots.")}(),await async function(e){return new Promise(((t,s)=>{i.appendFile(n,JSON.stringify(e)+"\n",(function(e){if(e)return s(`Failed to write to job log: ${JSON.stringify(e)}`);Math.random()>.9&&(console.log("Truncating log file"),async function(){if(!c)return c=!0,new Promise(((e,t)=>{i.readFile(n,"utf8",(function(s,r){if(s)return c=!1,t(s);try{const t=r.split("\n").slice(-25);i.writeFileSync(n,t.join("\n"),"utf8"),e()}catch(e){t(e)}finally{c=!1}}))}))}().catch((e=>{console.error("Failed to truncate job file",e)}))),t()}))}))}(e)}}))}async function p(){let e=await async function(){let e=0;for(const t of o)"running"===(await t.instance.getJobState()).state&&e++;return e}();return console.log(`getOpenJobSlotCount() says runningJobCount: ${e}`),3-e}d().then((()=>{console.log("Initialized JobManager")})),e.exports={index:async function(){return o.map((e=>e))},start:async function(e,t){const s=o.findIndex((e=>e.id===t.getId()));if(s>-1)return o[s].instance.getJobState();await t.initJobState();let i=await t.getJobState();return console.log(`JobManager started ${e} with id ${t.getId()}`),await p()>0?(console.log("JobManager will process now."),i=await t.process()):console.log("JobManager will queue."),o.push({type:e,id:t.getId(),instance:t}),i},stop:async function(e){const t=o.findIndex((t=>t.id===e));if(t<0)throw new Error("Invalid job id");try{return o[t].instance.stop(),!0}catch(t){throw new Error(`Failed to stop job (${e}) because job instance threw exception ${t.message}`)}},get:async function(e){const t=o.findIndex((t=>t.id===e));return t<0?null:o[t]},destroy:async function(e){const t=o.findIndex((t=>t.id===e));if(t<0)return console.warn(`No job with id ${e} to destroy.`),!1;try{return await o[t].instance.stop(),!0}catch(e){return console.error(`Error stopping job: ${e.message}`),!1}},init:d,findExisting:async function(e,t){const s=o.findIndex((s=>s.id===t&&s.type===e));return s>-1?o[s]:null}}},4525:(e,t,s)=>{const i=s(4913);let r=null;async function a(e){await Promise.all([i.setLED(1,e),i.setLED(2,e),i.setLED(3,e)])}async function o(){return r&&clearInterval(r),a(!1)}async function n(e){e||(e=900),console.log(`startTransportRotation ${e}`);let t=1;const s=[1,2,3];r&&clearInterval(r),r=setInterval((async()=>{for(const e of s)e===t?await i.setLED(e,!0):await i.setLED(e,!1);3===t?t=1:t++}),e)}e.exports={setAllLeds:a,setLedState:async function(e,t){await i.setLED(e,t)},flashAll:async function(e,t){t||(t=500);let s=0,i=!1,r=setInterval((async()=>{if(s++,s>=2*e)return await a(!1),void clearInterval(r);i?(i=!1,await a(!1)):(i=!0,await a(!0))}),t)},startTransportRotation:n,stopTransportRotation:o,waveHi:async function(){console.log("led wave hi"),await a(!1),await n(500),setTimeout((async()=>{await o(),await a(!0),setTimeout((async()=>{await a(!1)}),2e3)}),5e3)}}},1436:(e,t,s)=>{const i=s(4306),r=s(3619),{networkInterfaces:a}=s(2037),{Bonjour:o}=s(3423),n=new o,{existsSync:c}=s(7147);let l=!1;async function d(){const e=a();let t=[];for(const s of Object.keys(e))for(const i of e[s])"IPv4"!==i.family||i.internal||t.push(i.address);return 0===t.length?null:t[t.length-1]}e.exports={publish:async function(){if(c("/etc/avahi/services/ds.service"))return void console.log("Network skipping publish because avahi is configured.");const e=await i.get();console.log("Publishing bonjour",e),l&&(console.log("Unpublishing..."),await n.unpublishAll()),l=!0;let t={name:e,type:"http",port:r.dsApiPort||8081},s=await d();s&&console.log(`network got ipv4 using for publishing host ${s}`),setTimeout((()=>{console.log(`Publishing bonjour: ${JSON.stringify(t)}`),n.publish(t).on("up",(()=>{}))}),3e3)},ipv4:d}},6552:(e,t,s)=>{const i=s(3361),r=(s(4525),s(6737)),a=s(4386),o=(s(3619),s(3489),s(1403));e.exports=new class{player;playable;playbackReportingInterval;playing=!1;buffering=!1;seconds=0;offset=0;state;constructor(){}getReport(e){return{playable:this.playable?{...this.playable}:null,state:this.state,offset:this.offset,seconds:this.seconds,hmsOffset:this.niceHMS(this.offset),hmsSeconds:this.niceHMS(this.seconds),...e}}report(e){e||(e={});const t={name:"playback",data:this.getReport(e)};a.pub("store",t)}async init(){console.log("MPV.init"),await r.update({relay:!0}),console.log("MPV kill jackd if running"),await i.killIfRunning(),console.log("MPV ensure bit-perfect playback where possible"),await i.changeSampleRate(96e3)}reportStopped(){this.report({playable:null,state:"stopped",offset:null,seconds:null,hmsOffset:null,hmsSeconds:null})}async quit(){if(console.log("MPV.quit()"),this.player)try{await this.player.quit()}catch(e){console.error(`MPV.quit() exception, said: ${e.message}`)}return await this.stop(),!0}async play(e){if(console.log("MPV.play()",e.uri),this.playable=e,await this.init(),this.player)try{console.log("MPV: Player exists, attempting to quit mpv player."),await this.player.quit()}catch(e){console.error(`Failed to quit music player: ${e.message}`)}console.log("MPV initializing new player"),this.player=new o({app:"mpv",ipcPath:"/dropstation/media-ctl-socket",args:["--audio-device=alsa/ds_96","--no-video"],media:`${e.uri}`}),this.state="playing",this.playbackReportingInterval&&clearInterval(this.playbackReportingInterval),this.playbackReportingInterval=setInterval((()=>{this.report()}),1e3),this.player.on("app-exit",(e=>{console.log(`Player says app-exit, reporting stopped with code ${e}`),this.reportStopped(),setTimeout((async()=>{await i.adcSleep()}),250)})),this.player.launch((e=>{if(e)return console.error(e.message)})),this.player.on("playback-started",(()=>{console.log("MPV.playback-started")})),this.player.on("playback",(e=>{"duration"===e.name?this.seconds=e.value:"time-pos"===e.name&&(this.offset=e.value)}))}async stop(){console.log("MPV.stop()"),this.playbackReportingInterval&&clearInterval(this.playbackReportingInterval),this.state="stopped",this.reportStopped(),this.player?(this.player.stop(),this.player=null,await i.adcSleep()):console.log("MPV: received stop() but I was not playing?")}async togglePlay(){"stopped"!==this.state&&this.player||(console.log("Cannot togglePlay, stopped."),this.reportStopped()),"paused"===this.state?(this.state="playing",console.log("this.player.play"),this.player.play()):(this.state="paused",console.log("this.player.pause"),this.player.pause())}async fastForward(){const e=this.seconds-5;return this.offset<e&&(this.player.seek(this.offset+5),!0)}async rewind(){return this.offset>5&&(this.player.seek(this.offset-5),!0)}niceHMS(e){return!e||isNaN(parseInt(e))?"00:00:00":[e/3600,e%3600/60,e%60].map(this.format).join(":")}format(e){return`0${Math.floor(e)}`.slice(-2)}}},7567:e=>{e.exports=class{title;track;album;artist;image;uri;userid;username;avatar;id_discogs;rate=96e3;bits=24;format="flac";context_type;context_id;context;constructor(e){Object.assign(this,e)}}},3489:(e,t,s)=>{const i=s(9242),r={captureAutoStopSeconds:{type:"number",default:1800},captureSampleRate:{type:"number",enum:[48,96,192],default:96},captureFormat:{enum:["flac","alac"],default:"flac"},outputFormat:{enum:["aac-48-256","aac-48-320","vorbis-48-q10","vorbis-48-q6","mp3-48-192","mp3-48-256","flac-48"],default:"mp3-48-256"},bar:{type:"string",default:"foo"}},a=new i({schema:r});a.all=()=>{let e=[];for(const t of Object.keys(r))e.push({name:t,value:a.get(t)});return e},a.keys=()=>Object.keys(r),e.exports=a},4386:e=>{e.exports=new class{channels={};last={};constructor(){}sub(e,t){this.channels[e]||(this.channels[e]=[]),this.channels[e].push(t)}pub(e,t){if(this.channels[e]){this.last[e]=t;for(const s of this.channels[e])s(t)}}getLast(){return this.last}}},1821:(e,t,s)=>{const i=s(3619),r=s(2123),a=s(7147),o=s(1017),n=i.shareDir;function c(e,t){return`${r.validFilename(e)}/${r.validFilename(t)}`}function l(e,t){return`${n}/${c(e,t)}`}function d(e,t,s){return s=o.basename(s),`${l(e,t)}/${s}`}e.exports={addShare:async function(e,t,s){try{if(!a.existsSync(s))return console.warn(`share.addShare can't link missing file: ${s}`),!1;let i=`${n}/${r.validFilename(e)}`;a.existsSync(i)||a.mkdirSync(i);let c=`${i}/${r.validFilename(t)}`;a.existsSync(c)||a.mkdirSync(c);let l=`${c}/${o.basename(s)}`;return a.existsSync(l)||a.symlinkSync(s,l),!0}catch(e){return console.warn(`share.addShare failed: ${s} - ${e.message}`),!1}},ensureSharedRecording,cleanupEmptyShareDir:async function(e,t){let s=c(e,t);try{if(0===a.readdirSync(s).length)return a.rmSync(s),!0}catch(e){return!1}},getArtistAlbumSharePath:c,removeAllSharesByArtistAlbum:async function(e,t){let s=l(e,t);if(console.log(`share: requesting removal of dir: ${s}`),!a.existsSync(s))return console.warn(`share: couldn't remove shares for ${e} / ${t} at ${s} because it doesn't exist`),!0;for(const e of a.readdirSync(s))try{a.unlinkSync(o.join(s,e))}catch(t){console.warn(`share failed to delete ${e}`)}},removeShareByArtistAlbum:async function(e,t,s){let i=d(e,t,s);try{return a.existsSync(i)?(a.unlinkSync(i),!0):(console.warn(`share.removeShareByArtistAlbum cannot delete ${i} (${s}) because it doesn't exist`),!1)}catch(e){return console.warn(`share.removeShareByArtistAlbum failed: ${e.message}`),!1}},getArtistAlbumFilePath:d,getArtistAlbumShareDir:l}},3771:(e,t,s)=>{const{EventEmitter:i}=s(1239);e.exports=class extends i{mpv;duration;constructor(){super()}async init(){}async ensureMpv(){}async play(e,t){console.log("Player.play",{url:e,offset:t}),this.emit("duration",this.duration),console.log("fired")}async seek(e){return this.mpv.goToPosition(e)}async resume(){this.mpv.isPaused()&&this.mpv.resume()}async stop(){this.mpv.isRunning()&&await this.mpv.quit()}async pause(){if(!this.mpv.isPaused())return this.mpv.pause()}}},3271:(e,t,s)=>{const i=s(3771);let r=null;async function a(){return r||(r=new i,r)}e.exports={play:async function(e,t){await(await a()).play(e.url,t)},stop:async function(){await(await a()).stop()},pause:async function(){},seek:async function(e){}}},9189:(e,t,s)=>{const i=s(5653),r=s(5597),a=s(4386),{ValidationError:o}=s(5636),n=(s(3619),s(4306)),c=s(7147),l=s(6113),d=s(2167);e.exports=class extends r{session;reportingInterval;uploadBytes=0;uploadBytesUploaded=0;jobState;drop;constructor(e){super(),this.session=e}getId(){return`BurntableSync-${this.session.id}`}getTitle(){return`Burntable Sync for ${this.session.title}`}async initJobState(){this.jobState={object:"Session",object_id:this.session.id,data:{...this.session},id:this.getId(),title:"Syncing to burntable",name:"burntable_sync",status:"Queued...",state:"queued",completed:!1,progress:!0},this.reportingInterval=setInterval((()=>{console.log("this.jobState.progress",this.jobState.progress),a.pub("job",this.jobState)}),3e3)}async getJobState(){return this.jobState}async stop(){this.reportingInterval&&clearInterval(this.reportingInterval),a.pub("job",{...this.jobState,state:"failed",completed:!0,error:"Stopped manually"})}reportFailure(e){this.reportingInterval&&clearInterval(this.reportingInterval),a.pub("job",{...this.jobState,state:"failed",completed:!0,error:e})}async process(){if(this.jobState.state="running",!this.session.id_discogs)throw this.reportFailure("Burntable requires a discogs release id."),new o("Failed to create drop",{id_discogs:["Burntable requires a discogs release id."]});if(!i.getBearer())throw this.reportFailure("Burntable is not connected.  Please re-connect Burntable."),new o("Failed to create drop",{user_id:["Burntable is not connected."]});try{await this.ensureDrop(),await this.loadDrop(),this.debug("Drop loaded",this.drop)}catch(e){throw console.error("Error creating drop",e),this.reportFailure(`Burntable error: ${e.message}`),new o("Failed to create drop",{drop_id:[`Failed to create drop.  ${e.message}`]})}return(async()=>{await this.ensurePhoto(),await this.ensureAudioFiles(),await this.submitDrop()})().then((()=>{this.jobState.state="completed",this.jobState.progress=100})).catch((e=>{this.jobState.state="failed",this.jobState.error=e.message})).finally((()=>{this.reportingInterval&&clearInterval(this.reportingInterval),this.jobState.completed=!0,a.pub("job",this.jobState)})),this.jobState}debug(e,t){console.log(`BurntableSync: ${e}`,t)}async ensureDrop(){let e,t={title:this.session.title,description:this.session.description,media_grade:this.session.media_grade,release_version_id:await this.ensureReleaseVersionCapture(this.session.id_discogs)};this.jobState.status="Ensuring Drop exists",this.debug("ensureDrop() dropData",t),this.session.drop_id?(this.debug("Sending put request, drop exists"),e=await i.getClient().put(`drops/${this.session.drop_id}`,t)):(this.debug("Sending post request for new drop"),e=await i.getClient().post("drops",t)),this.debug("ensureDrop() dropResponse",e.data),this.session.drop_id=e.data.id,this.session.save(),a.pub("store",{name:"session",data:{...this.session}})}async submitDrop(){if(!this.drop||!this.drop.id)return void console.error("Cannot submit drop without drop id");const e=`drops/${this.drop.id}/submissions`;await i.getClient().post(e).then((e=>{console.log(`Drop ID ${this.drop.id} was submitted`)})).catch((e=>{console.error("Failed to submit drop for processing:"),e.response&&e.response.data&&console.error(JSON.stringify(e.response.data))}))}async ensurePhoto(){if(await this.getDropPhoto())this.debug("Drop already has photo, good.");else if(this.session.image)try{const e=c.statSync(this.session.image).size,t="image/jpeg",s=await i.getClient().post("draft_uploads",{attachable_type:"Drop",attachable_id:this.drop.id,filesize:e,filename:"dropstation-image.jpg",mime_type:t,role:"photo"}),r=s.data.signed_url,a=s.data.id,o=c.createReadStream(this.session.image,{highWaterMark:262144});this.debug(`Uploading to s3 at ${r}`),await d.put(r,o,{headers:{"Content-Type":t,"Content-Length":e}});let n=await i.getClient().put(`draft_uploads/${a}/completion`);return this.debug("Draft upload completed",n.data),!0}catch(e){return this.debug(`Failed while syncing album cover image: ${e.message}`,e),!1}else this.debug("Session has no image, aborting ensurePhoto().")}async loadDrop(){let e=await i.getClient().get(`drops/${this.session.drop_id}`);this.drop=e.data}async getDropAttachments(e){return this.drop||await this.loadDrop(),e?this.drop.attachments.filter((t=>t.role===e)).map((e=>this.attachmentWithSide(e))):this.drop.attachments.map((e=>this.attachmentWithSide(e)))}async getDropPhoto(){let e=await this.getDropAttachments("photo");return e&&0!==e.length?e[0]:null}attachmentWithSide(e){if("upload"!==e.role)return e;try{e.side=e.filename.match(/(\w)\.flac$/)[1].toUpperCase()}catch(e){}return e}async ensureReleaseVersionCapture(e){try{return this.debug(`Posting to db/releases/${e}/captures`),(await i.getClient().post(`db/releases/${e}/captures`,{})).data.id}catch(e){throw e.response&&e.response.data?new o("Failed to capture discogs release",e.response.data):new o("Failed to capture discogs release.",{id_discogs:[e.message]})}}async ensureAudioFiles(){let e=await this.getDropAttachments("upload");for(const t of this.session.recordings){if(e.find((e=>e.side===t.side))){this.debug(`Side ${t.side} was already uploaded`);continue}const s=c.statSync(t.file);this.uploadBytes+=s.size}this.debug(`Will upload ${this.uploadBytes} bytes`);for(const t of this.session.recordings)e.find((e=>e.side===t.side))?this.debug(`Side ${t.side} was already uploaded`):(this.jobState.status=`Uploading side ${t.side}`,await this.uploadRecording(t))}async uploadRecording(e){if(!this.drop.id)throw new Error("Cannot uploadRecording because there is no drop id");return new Promise((async(t,s)=>{try{let r=e.file;const a=c.statSync(r).size,o="audio/flac",p=10485760,u=Math.ceil(a/p),h=l.createHash("md5").update(`${r}-${await n.get()}`).digest("hex"),g=(await i.getClient().post("draft_uploads",{attachable_type:"Drop",attachable_id:this.drop.id,filesize:a,filename:`Side${e.side}.flac`,mime_type:o,role:"upload",multipart_count:u,md5:h})).data,m=g.id;let f=[];g.draft_upload_parts&&(f=g.draft_upload_parts.filter((e=>!!e.etag)).map((e=>e.part)));const y=c.createReadStream(r,{highWaterMark:p});let b=0;y.on("data",(async e=>{if(b++,f.indexOf(b)>-1)return this.debug(`Already uploaded part ${b}`),void(b===u&&t(await this.completeDraftUpload(m)));this.debug(`Uploading chunk ${b} (${e.byteLength} bytes)`),y.pause();try{const s=(await i.getClient().post("draft_upload_parts",{draft_upload_id:m,part:b})).data,r=await d.put(s.signed_url,e,{headers:{"Content-Type":o,"Content-Length":e.byteLength},maxBodyLength:2e7,maxContentLength:2e7,onUploadProgress:e=>{try{const t=e.loaded;console.log("loaded",t),this.uploadBytesUploaded+=t,this.uploadBytesUploaded>0&&this.uploadBytes>0&&(this.jobState.progress=Math.floor(this.uploadBytesUploaded/this.uploadBytes*100))}catch(e){console.error("onUploadProgress",e)}}});this.uploadBytesUploaded+=e.byteLength,this.uploadBytesUploaded>0&&this.uploadBytes>0&&(this.jobState.progress=Math.floor(this.uploadBytesUploaded/this.uploadBytes*100)),await i.getClient().put(`draft_upload_parts/${s.id}`,{etag:r.headers.etag}).then((e=>{this.debug(`Set etag for part ${b} as ${r.headers.etag}`)})),b===u&&t(await this.completeDraftUpload(m)),y.resume()}catch(e){console.error("error handling upload chunk",e),s(`Failed while uploading audio file: ${e.message}`)}})),y.on("end",(async()=>{})),y.on("error",(e=>{console.log(" Error reading %s",r),s(e)}))}catch(e){this.debug(`Failed while uploading audio file: ${e.message}`,e),s(`Failed while uploading audio file: ${e.message}`)}}))}async completeDraftUpload(e){return i.getClient().post(`draft_uploads/${e}/completion`).then((e=>(this.debug("Draft upload completed",e.data),e.data))).catch((e=>{throw this.debug("Draft upload completion failed"),e.response&&e.response.data&&this.debug("Error information",e.response.data),new Error(`Upload completion failed: ${e.message}`)}))}}},5597:(e,t,s)=>{const i=s(1041),r=s(7147);e.exports=class{getId(){throw"getId() not implemented"}async initJobState(){throw"initJobState() not implemented"}async getJobState(){throw"getJobState() not implemented"}getTitle(){throw"getTitle() not implemented"}async process(){throw"process() not implemented"}async stop(){throw"stop() not implemented"}async killProcesses(e){for(const t of e)await this.killProcess(t).catch((e=>{console.warn(e)}))}async killProcess(e){return new Promise(((t,s)=>{try{e&&e.pid?i(e.pid,"SIGKILL",(i=>{if(i)return s(`Job.stop() failed to kill ${e.pid}: ${i}`);t(`Job.killProcess() killed ${e.pid}`)})):s(`Cannot kill ${typeof e} because it didn't exist as a property with a pid`)}catch(t){return s(`Job.killProcess().catch() failed to kill ${typeof e}: ${t.message}`)}}))}async removeFiles(e){for(const t of e)try{r.unlinkSync(t)}catch(e){console.log(`Didn't delete ${t} because it didn't exist`)}}}},6815:(e,t,s)=>{const i=s(5597),r=s(4386);e.exports=class extends i{id;reportingInterval;jobState;doneTimeout;constructor(){super(),this.id=Date.now()/1e3}getId(){return`MockJob-${this.id}`}getTitle(){return`MockJob id ${this.id}`}async stop(){this.reportingInterval&&clearInterval(this.reportingInterval),this.doneTimeout&&clearTimeout(this.doneTimeout),r.pub("job",{...this.jobState,completed:!0,error:"Stopped manually"})}async process(){return this.doneTimeout=setTimeout((()=>{clearInterval(this.reportingInterval),r.pub("job",{...this.jobState,completed:!0})}),1e4),this.jobState={object:"Mock",object_id:123,data:{id:123,title:"None - Mock Job"},id:this.getId(),title:"Mock Job",name:"mockjob",status:"Working very hard",completed:!1,progress:!0},this.reportingInterval=setInterval((()=>{r.pub("job",this.jobState)}),3e3),this.jobState}}},3786:e=>{e.exports={bitmagic:function(e){let t=[...e.matchAll(/([dbh]{1})\[([^\]]+)\]/g)].reduce(((e,t)=>{let[s,i]=t[2].split(",");return"b"===t[1]?e+=`${s}`:"d"===t[1]?e+=(s>>>0).toString(2).padStart(i||0,"0"):"h"===t[1]&&(e+=`${parseInt(s,16).toString(2).padStart(i||0,"0")}`),e}),"");return{b:t,d:parseInt(t,2),h:"0x"+parseInt(t,2).toString(16)}}}},3846:(e,t,s)=>{const i=s(325);e.exports=class{addr;bus;i2c;constructor(e,t){this.addr=t,this.bus=e,console.log(`I2CLink opening bus ${e} at address ${t}`),this.i2c=i.openSync(this.bus),console.log(`I2CLink opened bus ${e}`)}async close(){console.log("I2CLink closing bus"),this.i2c.closeSync()}async i2cWriteByte(e,t){this.i2c.writeByteSync(this.addr,e,t),console.log(`w ${this.addr} reg 0x${e.toString(16)} val 0x${t.toString(16)} b${(t>>>0).toString(2)}`),await new Promise((e=>setTimeout(e,180)))}async i2cReadByte(e){await new Promise((e=>setTimeout(e,100)));let t=this.i2c.readByteSync(this.addr,e);return{reg:e,h:"0x"+t.toString(16),b:(t>>>0).toString(2)}}}},4610:e=>{e.exports={sleep:function(e){return new Promise((t=>{setTimeout(t,e)}))}}},2123:e=>{const t="CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, LPT9".split(", ").join("|");function s(e){let t="";const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=s.length;for(let r=0;r<e;r++)t+=s.charAt(Math.floor(Math.random()*i));return t}e.exports={validFilename:function(e){return e?e.replace(/[\\\\/:*?%\"<>|]/g,"").replace(new RegExp("^("+t+")$"),"-").replace(/\-{2,}/g,"-").replace(/\s{2,}/g," ").substring(0,100).replace(/[^\w\d\)]+$/,"")||s(20):null},randomString:s}},5647:e=>{"use strict";e.exports=require("@fastify/cors")},9450:e=>{"use strict";e.exports=require("@fastify/http-proxy")},2782:e=>{"use strict";e.exports=require("@fastify/multipart")},871:e=>{"use strict";e.exports=require("@fastify/static")},2167:e=>{"use strict";e.exports=require("axios")},7096:e=>{"use strict";e.exports=require("bcrypt")},3423:e=>{"use strict";e.exports=require("bonjour-service")},9242:e=>{"use strict";e.exports=require("conf")},5142:e=>{"use strict";e.exports=require("dotenv")},1239:e=>{"use strict";e.exports=require("events")},1442:e=>{"use strict";e.exports=require("fastify")},325:e=>{"use strict";e.exports=require("i2c-bus")},2408:e=>{"use strict";e.exports=require("input-event")},1403:e=>{"use strict";e.exports=require("media-player-controller")},2544:e=>{"use strict";e.exports=require("rpi-gpio")},7441:e=>{"use strict";e.exports=require("sharp")},1041:e=>{"use strict";e.exports=require("tree-kill")},5352:e=>{"use strict";e.exports=require("ws")},2081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},7147:e=>{"use strict";e.exports=require("fs")},2037:e=>{"use strict";e.exports=require("os")},1017:e=>{"use strict";e.exports=require("path")}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,s),a.exports}(()=>{const e=s(5352),t=s(4386),{spawn:i,exec:r,execSync:a}=s(2081),o=s(1436),n=s(7147),c=s(3619),l=(s(4306),s(5898)),d=s(4525),p=s(3361),u=s(4408);c.dataIsMount&&console.log("MOUNTED: /dropstation recognized as mounted dedicated drive."),console.log(`Driver is ${c.driver}`),u.on("exit",(()=>{console.log("Transport.on(exit)")})),u.on("error",(e=>{console.error("Transport.on(error)",e)}));const h=s(9549);["/dropstation/data/sessions","/dropstation/shared"].map((e=>{n.existsSync(e)||(console.log(`Creating ${e}`),n.mkdirSync(e,{recursive:!0}))}));const g=s(4913),m=p;m.on("debug",console.debug),m.on("error",(e=>{console.error("JackManager.error is "+typeof e,e)})),(async()=>{await d.startTransportRotation(2e3),await g.init(),await d.stopTransportRotation(),await d.waveHi(),await h.observe((async e=>{console.log(`button.observe ${e}`),"sleep"===e?(await d.flashAll(1,250),a("sudo poweroff")):"reboot"===e?(await d.flashAll(2,250),a("sudo reboot now")):"stop"===e&&(await d.flashAll(1,250),await o.publish(),u.isRecording()&&u.stop().then((e=>{})))})),await o.publish()})(),process.on("exit",(()=>{console.log("process.on exit");try{a("sudo killall jack_capture")}catch(e){console.log("jack_capture not running...")}try{a("sudo killall jackd")}catch(e){console.log("jackd not running...")}process.kill(process.pid,"SIGTERM")}));const f=c.dsApiPort||8081,{join:y}=s(1017),b=s(8558),w=s(3666),S=s(5193),v=s(5852),$=s(2945),k=s(6105),x=s(6863),j=s(9763),_=s(8264),I=s(4143),R=s(6714),P=s(2714),T=s(437),F=(s(267),s(1442)({logger:!1}));F.register(s(2782),{fileSize:1e7,files:1}),F.register(s(871),{root:c.dataDir,prefix:"/files",decorateReply:!1,setHeaders:(e,t,s)=>{e.setHeader("expires","0"),e.setHeader("pragma-directive","no-cache"),e.setHeader("cache-control","no-cache"),e.setHeader("Pragma","no-cache"),e.setHeader("Cache-directive","no-cache")}}),F.register(s(5647),{origin:!0,methods:["GET","PUT","POST","DELETE","OPTIONS"],exposedHeaders:["Content-Type","Authorization"],credentials:!0}),F.addHook("onRequest",(async(e,t)=>{if("/files/*"===e.routerPath)return;if("/management/auth"===e.routerPath&&["GET","POST"].indexOf(e.routerMethod)>-1)return;if("/management/authentication"===e.routerPath&&"POST"===e.routerMethod)return;let s=await l.getPinHash();!s||e.headers.dspin&&s===e.headers.dspin||t.code(403).send({message:"Access denied"})})),F.setErrorHandler((function(e,t,s){if(console.log("error handler",e.message,e.name,e.stack),"ValidationError"===e.name)return s.code(422).send(e.errors);s.code(500).send({message:"System Error",error:e.message})})),F.get("/management/auth",b.get),F.post("/management/auth",b.post),F.put("/management/auth",b.put),F.delete("/management/auth",b.del),F.post("/management/authentication",b.authentication);const A=s(202);F.register(A.proxyHandler),F.register(A.authHandler,{prefix:"/bt-auth"}),F.get("/utilities/fix_mount",T.fixMount),F.get("/utilities/copy_temp_files",T.copyTempFiles),F.post("/playback/init",w.init),F.post("/playback",w.play),F.delete("/playback",w.quit),F.post("/playback/toggle_play",w.togglePlay),F.post("/playback/rewind",w.rewind),F.post("/playback/fast_forward",w.fastForward),F.post("/playback/skip_next",w.skipNext),F.post("/playback/skip_previous",w.skipPrevious),F.get("/sessions",$.index),F.post("/sessions",$.store),F.get("/sessions/:id",$.read),F.put("/sessions/:id",$.update),F.delete("/sessions/:id",$.destroy),F.post("/sessions/:id/cleanups",$.cleanup),F.delete("/sessions/:id/:side",$.deleteRecording),F.post("/sessions/:id/burntable_sync",P.ensureSync),F.get("/sessions/:id/:side",$.getRecording),F.post("/sessions/:id/image",x.upload),F.post("/sessions/:id/recordings/:side/trim",v.store),F.post("/sessions/:id/recordings/:side/post_capture",S.storePostCapture),F.put("/sessions/:id/release_version",$.updateReleaseVersion),F.post("/sessions/:id/normalizations",_.store),F.post("/sessions/:id/:side/reversions",R.storeReversion),F.put("/sessions/:id/:side/tracks",I.store),F.get("/sessions/:id/tracks",I.index),F.get("/sessions/:id/:side/tracks",I.index),F.delete("/sessions/:id/:side/tracks/:position",I.destroy),F.post("/sessions/:id/:side/tracks/process",I.process),F.get("/jobs",j.index),F.post("/jobs",j.store),F.delete("/jobs/:id",j.destroy),F.post("/captures/record",S.record),F.post("/captures/stop",S.stop),F.get("/preferences",k.index),F.put("/preferences",k.update);const D=s(7534);F.get("/state",D.index),F.put("/state",D.update),F.get("/debug",D.debug),F.get("/state/softmon",D.getSoftMon),F.put("/state/softmon",D.putSoftMon),F.get("/ws/last",((e,s)=>{s.send(t.getLast())}));const E=s(7232);F.post("/updates",E.store),F.get("/",(async(e,t)=>{t.send({message:"Welcome to DropStation."})})),(async()=>{try{await F.listen({port:3e3,host:"0.0.0.0"})}catch(e){F.log.error(e),process.exit(1)}})().then((()=>{console.log("started web server")}));let M=parseInt(f)+1;const B=new e.Server({host:"0.0.0.0",port:M});B.on("listening",(()=>{console.log("ws listening",M)}));const C=setInterval((()=>{B.clients.forEach((e=>{if(!1===e.isAlive)return e.terminate();e.isAliveTimeout=setTimeout((()=>{e.awaitingSup&&(console.log("ws: Client gone, terminating."),e.terminate())}),500),e.send("yo"),e.awaitingSup=!0}))}),5e3);B.on("close",(function(){clearInterval(C)})),B.on("connection",(function(e){e.isAlive=!0,e.awaitingSup=!1,e.on("message",(function(t){e.awaitingSup=!1})),t.sub("levels",(t=>{e.send(JSON.stringify({event:"levels",levels:t}))})),t.sub("store",(({name:t,data:s})=>{e.send(JSON.stringify({event:"store",name:t,data:s}))})),t.sub("job",(t=>{e.send(JSON.stringify({event:"job",job:t}))})),e.send(JSON.stringify({message:"Welcome to DropStation"}))})),process.on("uncaughtException",(e=>{console.error("uncaughtException",e)}))})()})();
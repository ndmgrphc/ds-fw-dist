(()=>{var e={5193:(e,t,s)=>{const r=s(6217),i=s(3882),o=s(4408),{ValidationError:n}=s(5636),a=s(8370);e.exports={record:async function(e,t){const s=new r;s.load(e.body.session_id),o.isRecording()?t.send({status:"recording",message:"Already recording."}):(await o.record(s,e.body.side),t.send({status:"recording"}))},stop:async function(e,t){let s=await o.stop();t.send(s)},storePostCapture:async function(e,t){try{let s=new r;await s.load(e.params.id);let o=await s.getRecording(e.params.side),n=await a.get(`PostCapture-${o.id}`);if(n)return console.log("CaptureController.storePostCapture, job exists..."),t.send({job:n.instance.getJobState()});let c=new i(s,e.params.side),l=await c.process();await a.start("PostCapture",c),t.send({job:l})}catch(e){throw new n("Validation errors.",{session_id:[e.message]})}}}},202:(e,t,s)=>{const r=s(5653),i=s(9450);e.exports={proxyHandler:async function(e){e.register(i,{upstream:"https://burntable.com",http2:!1,prefix:"/bt",replyOptions:{rewriteRequestHeaders:(e,t)=>{console.log("rewriteRequestHeaders",r.getBearer());let s={...t,authorization:"Bearer "+r.getBearer(),accept:"application/json"};return delete s.dspin,s},rewriteHeaders:e=>({...e,"x-bt-token":r.getBearer()})}})},authHandler:async function(e){e.put("/token",(async(e,t)=>{const s=await r.setBearer(e.body.token);t.send({token:s})})),e.delete("/token",(async(e,t)=>{await r.deleteBearer(),t.send({result:"disconnected"})}))}}},7534:(e,t,s)=>{const r=s(6737);e.exports={index:async function(e,t){t.send(await r.index())},update:async function(e,t){if("object"!=typeof e.body)throw new Error("Missing application/json Content-type header");t.send(await r.update(e.body))}}},6863:(e,t,s)=>{s(7147);const r=s(6217);e.exports={upload:async function(e,t){let s=e.params.id,i=new r;i.load(s);try{const t=await e.saveRequestFiles();console.log("files",t),await i.updateImage(t[0].filepath)}catch(e){console.error("upload request error",e.message,e)}t.send({...i})}}},9763:(e,t,s)=>{const r=s(8370),i=s(6815);e.exports={store:async function(e,t){let s=new i,o=await s.process();await r.start("MockJob",s),t.send({job:o})},index:async function(e,t){t.send(await r.index())},destroy:async function(e,t){const s=e.params.id;console.log(`Request to destroy job ${s}`),t.send({result:await r.destroy(s)})}}},8558:(e,t,s)=>{const r=s(5898);e.exports={get:async function(e,t){const s=await r.getPinHash();let i={protected:!!s,authenticated:!s||!(!e.headers.dspin||e.headers.dspin!==s)};t.send(i)},post:async function(e,t){const s=await r.updatePinHash(null,e.body.new_pin);t.send({result:"success",dspin:s})},put:async function(e,t){const s=await r.updatePinHash(e.body.current_pin,e.body.new_pin);t.send({result:"success",dspin:s})},del:async function(e,t){},authentication:async function(e,t){const s=await r.authenticate(e.body.pin);t.send({result:"success",dspin:s})}}},8264:(e,t,s)=>{const r=s(6217),i=s(6212),o=s(8370),{ValidationError:n}=s(5636);e.exports={store:async function(e,t){try{const s=e.params.id;let n=new r;await n.load(s),n.normalized;let a=await o.get(`Normalizer-${s}`);if(a)return t.send({job:a.instance.getJobState()});let c=new i(n),l=await c.process();await o.start("Normalizer",c),t.send({job:l})}catch(e){throw new n("Validation errors.",{session_id:[e.message]})}}}},3666:(e,t,s)=>{s(3271);const r=s(5653),i=s(6552),o=s(6217),n=s(7567);e.exports={play:async function(e,t){try{if("Session"===e.body.context_type){let s=new o;await s.load(e.body.context_id);let r=new n({context_type:"Session",context_id:s.id,rate:e.body.recording.rate,format:e.body.recording.format,bits:e.body.recording.bits,album:s.title,title:`Side ${e.body.recording.side}`,uri:e.body.recording.file,image:s.image,context:s});await i.play(r),t.send({playable:{...r}})}else if("Drop"===e.body.context_type){const s=await r.getClient().post("plays",{drop_id:e.body.context_id,side:e.body.side,format:"aac"});console.log(s.data);let o=s.data.drop,a=new n({title:`Side ${e.body.side}`,track:e.body.side,album:o.release_version.title,artist:o.release_version.artist.title,image:o.photo.url,uri:s.data.audio.url,id_discogs:o.release_version.id_discogs,rate:96e3,bits:24,format:s.data.audio.codec,context_type:"Drop",context_id:o.id,context:o});try{await i.play(a)}catch(e){console.error(e)}t.send({playable:{...a}})}}catch(e){t.send({error:e.message})}},togglePlay:async function(e,t){try{await i.togglePlay()}catch(e){console.error(`togglePlay Error: ${e.message}`)}t.send({status:"done"})},quit:async function(e,t){try{await i.quit()}catch(e){}t.send({status:"stopped"})},fastForward:async function(e,t){try{await i.fastForward()}catch(e){}t.send({status:"done"})},skipNext:async function(e,t){t.send({status:"done"})},skipPrevious:async function(e,t){t.send({status:"done"})},rewind:async function(e,t){try{await i.rewind()}catch(e){}t.send({status:"done"})},init:async function(e,t){await i.init(),t.send({init:!0})}}},6105:(e,t,s)=>{const r=s(3489),{ValidationError:i}=s(5636);e.exports={index:async function(e,t){t.send(r.all())},update:async function(e,t){let s={},o=r.keys();console.log("validPreferences",o);for(const t of Object.keys(e.body))if(!o.indexOf(t)<0)console.error("Invalid key for preferences",t);else try{r.set(t,e.body[t])}catch(e){s[t]=[e.message]}if(Object.keys(s).length>0)throw new i("Validation errors.",s);t.send(r.all())}}},6714:(e,t,s)=>{const r=s(6217),i=(s(3619),s(8370)),o=s(1272),{ValidationError:n}=(s(7147),s(1017),s(5636));e.exports={storeReversion:async function(e,t){const s=e.params.id,n=e.body.state,a=new r;a.load(s);const c=await a.getRecordingBySide(e.params.side);let l=await i.get(`Reverter-Recording-${c.id}`);if(l)return t.send({job:l.instance.getJobState()});const d=new o(a,"Recording",c.id,n);let p=await d.process();await i.start("Reverter",d),t.send({job:p})}}},2945:(e,t,s)=>{const r=s(6217),i=s(3619),o=s(7147),{ValidationError:n}=(s(1017),s(5636));e.exports={index:async function(e,t){console.log("GET /sessions",`${i.dataDir}/sessions`);let s=o.readdirSync(`${i.dataDir}/sessions`,{withFileTypes:!0}).filter((e=>e.isDirectory()&&e.name.indexOf(".")<0)),r=s.map((e=>JSON.parse(o.readFileSync(`${i.dataDir}/sessions/${e.name}/session.json`,"utf-8")))).sort((function(e,t){return parseFloat(t.updated_at)-parseFloat(e.updated_at)}));t.send({data:r,total:s.length})},store:async function(e,t){let s=e.body.title,i=new r;return i.create(s),await i.save(),{...i}},read:async function(e,t){let s=e.params.id,i=new r;i.load(s),t.send({...i})},update:async function(e,t){let s=e.params.id,i=new r;i.load(s),i.update(e.body),t.send({...i})},destroy:async function(e,t){let s=e.params.id;try{o.rmSync(`${i.dataDir}/sessions/${s}`,{recursive:!0})}catch(e){console.log("Nothing to delete")}t.send({id:s})},deleteRecording:async function(e,t){let s=e.params.id,i=e.params.side,o=new r;o.load(s),await o.deleteSide(i),t.send({...o})},getRecording:async function(e,t){let s=e.params.id,i=e.params.side,o=new r;o.load(s);const n=await o.getRecordingBySide(i);let a=await n.getInfo(),c=await n.debug();t.send({...n,info:a,debug:c})},updateReleaseVersion:async function(e,t){let s=e.params.id,i=new r;if(i.load(s),!e.body||!e.body.release_version||!e.body.release_version.id)throw new n("No release version.",{release_version:["Not a valid release version"]});i.updateReleaseVersion(e.body.release_version),t.send({...i})}}},5852:(e,t,s)=>{const r=s(6217),{ValidationError:i}=s(5636),o=s(53),n=s(8370);e.exports={store:async function(e,t){for(const t of["from","to"])if(0!==e.body[t]&&(!e.body[t]||isNaN(parseFloat(e.body[t]))))throw new i("Validation errors.",{[t]:[`${t} is required and must be numeric`]});try{const s=e.params.id,i=e.params.side;let a=new r;await a.load(s);let c=await a.getRecordingBySide(i),l=await n.get(`Trimmer-${c.id}`);if(l)return t.send({job:l.instance.getJobState()});let d=new o(a,i),p=await d.trim(e.body.from,e.body.to);await n.start("Trimmer",d),t.send({job:p})}catch(e){throw new i("Validation errors.",{session_id:[e.message]})}}}},7232:(e,t,s)=>{const{spawn:r,exec:i,execSync:o}=s(2081);e.exports={store:async function(e,t){try{let e=await async function(){return new Promise(((e,t)=>{i("sudo apt-get --yes install mp3splt",((e,t,s)=>{e&&console.error("Failed to install startup packages")})),i("cd /home/ds/ds-fw-dist && git fetch --all && git reset --hard origin/master && yarn install && sudo chmod 755 ./init.sh && sudo chmod 755 ./update.sh && sudo chmod 755 ./wifi-connect/start-wifi-connect.sh",((s,r,i)=>{s?t(s):e(r)}))}))}();t.send({message:"Update completed",result:e}),async function(){return new Promise(((e,t)=>{try{o("ln -s /dropstation/data /dropstation/shared/data")}catch(e){console.error("Failed to create symlink to raw data",e.message)}i("sudo service ds restart",((s,r,i)=>{s?t(s):e("Updated.")}))}))}().then((e=>{console.log(`I don't think you'll ever see this...${e}`)}))}catch(e){t.send({message:"Update failed",result:JSON.stringify(e)})}}}},3361:(e,t,s)=>{const{spawn:r,exec:i,execSync:o}=s(2081),{EventEmitter:n}=s(1239);s(3489),e.exports=new class extends n{jackd;duration;lastSampleRate;sampleRateMap={48e3:{n:4,p:2048,m0:"dl",m1:"dl"},96e3:{n:4,p:4096,m0:"dh",m1:"dl"},192e3:{n:8,p:8192,m0:"dl",m1:"dh"}};constructor(){super();try{o("export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/dbus/system_bus_socket")}catch(e){console.error("Failed to export DBUS_SESSION_BUS_ADDRESS")}}async init(){}async isRunning(e){let t=process.platform,s="";switch(t){case"win32":s="tasklist";break;case"darwin":s=`ps -ax | grep ${e}`;break;case"linux":s="ps -A"}return this.emit("debug",`Checking jackd process status with ${s}`),new Promise(((t,r)=>{i(s,((s,r,i)=>{let o=r.toLowerCase().indexOf(e.toLowerCase())>-1;this.emit("debug",`Result of JackManager.isRunning(): ${o}`),t(o)}))}))}async ensure(e,t){let s=this;if(this.jackd&&!t)return this.emit("debug","Jackd is already running, no forceRestart requested."),this.jackd;if(await this.isRunning("jackd")){if(!t)return void this.emit("debug","jackd is already running");this.emit("debug","Jack ensure() forceRestart, killing jackd"),await this.kill()}return!e||[48,96,192].indexOf(e)<0?(this.emit("debug","JackManager.ensure received no sampleRate, using default."),e=96e3):e*=1e3,this.lastSampleRate=e,await this.changeSampleRate(e),this.emit("debug",`JackManager.ensure starting with a sampleRate of ${e}.`),this.jackd=r("jackd",["-d","alsa","-r",e,"-n",this.sampleRateMap[e].n,"-p",this.sampleRateMap[e].p,"-C","hw:CARD=GenericStereoAu,DEV=1","-P","hw:CARD=GenericStereoAu,DEV=0"],{env:{...process.env,JACK_NO_AUDIO_RESERVATION:"1",DBUS_SESSION_BUS_ADDRESS:"unix:path=/run/dbus/system_bus_socket"}}),new Promise(((e,t)=>{let r=setTimeout((()=>{t("Failed to start jackd within 10 seconds.  Check error logs and contact support.")}),1e4);this.jackd.on("exit",(function(e,t){s.jackd=null,e?s.emit("exit",`jackd exited with code ${e}`):t?s.emit("exit",`jackd exited with signal ${t}`):s.emit("exit","jackd exited on completion")})),this.jackd.on("close",(function(e,t){s.jackd=null,s.emit("close",`jackd closed with code ${e} and signal ${t}`)})),this.jackd.stdout.on("data",(function(t){let i=t.toString();console.log("jackd stdout",t.toString()),i.indexOf("periods for playback")>-1&&(clearTimeout(r),setTimeout((()=>{e("jackd started")}),1e3)),s.emit("data",t)})),this.jackd.stderr.on("data",(function(e){console.log("jackd stderr",e.toString());try{s.emit("error",e)}catch(e){console.log("jackd unhandled error")}}))}))}async changeSampleRate(e){if(!this.sampleRateMap[e])throw console.error(`JackManager.changeSampleRate() not a valid rate: ${e}`),Error(`${e} is not a valid sample rate`);o("raspi-gpio set 5 op pn dl"),o("raspi-gpio set 26 op pn dl"),o(`raspi-gpio set 6 op pn ${this.sampleRateMap[e].m0} && raspi-gpio set 13 op pn ${this.sampleRateMap[e].m1}`),o("raspi-gpio set 26 op pn dh"),o("raspi-gpio set 5 op pn dh")}async kill(){try{this.emit("debug","Killing jackd process"),o("killall jackd")}catch(e){console.log("jackd not running...")}}async isJackdRunning(){return this.isRunning("jackd")}async killIfRunning(){return!!await this.isRunning("jackd")&&(await this.kill(),!0)}}},267:(e,t,s)=>{e.exports=class{dataDir;recordingProcess;meteringProcess;averageLevelInterval;averageLevelIntervalMs=3e3;averageLevelSamples=[];averageLevel=0;constructor(e){this.dataDir=e.dataDir}async stop(){return this.recordingProcess.kill("SIGTERM")}meter(e){const t=this,{spawn:r}=s(2081);this.averageLevelInterval=setInterval((()=>{this.setAverageLevel(this.averageLevelSamples.reduce(((e,t)=>e+t),0)/this.averageLevelSamples.length),this.averageLevelSamples=[]}),this.averageLevelIntervalMs),this.meteringProcess=r("arecord",["-D","pulse","-f","dat","-c","2","-vv","/dev/null"],{stdio:["ignore","ignore","pipe"]}),this.meteringProcess.stderr.on("data",(function(s){let r=parseInt(String(s).substr(54,2));isNaN(r)||(t.averageLevelSamples.push(r),e&&e(r))}))}setAverageLevel(e){this.averageLevel=e,console.log("Average level",e)}async recordSideForSession(e,t){return this.record(`${t.id}-${e}`)}async record(e){const{spawn:t}=s(2081);return new Promise(((s,r)=>{this.recordingProcess=t("parec",["--rate=96000","--format=s24le","-d","alsa_input.platform-soc_sound.stereo-fallback","|","sox","-t","raw","-b","24","-e","signed","-c","2","-r","96000","-",`${this.dataDir}/${e}.wav`],{stdio:["ignore","ignore","pipe"]}),this.recordingProcess.on("close",((e,t)=>{s({code:e,signal:t})}))}))}}},5898:(e,t,s)=>{const r=s(7096),i=(s(1017),s(7147)),o=s(3619),{ValidationError:n}=s(5636),a=`${o.rootDataDir}/.PIN`;let c,l=null,d=0;async function p(e){const t=await r.hash(String(e),5);return i.writeFileSync(a,t,{encoding:"utf8",flag:"w"}),l=t,t}async function u(){if(l)return l;try{if(i.existsSync(a))return l=i.readFileSync(a,"utf8"),l}catch(e){return null}}e.exports={updatePinHash:async function(e,t){if(!/[0-9]{4}/.test(t))throw new n("Current pin entered is incorrect.",{new_pin:["Must be 4 numbers."]});const s=await u();if(!s)return console.log("updatePinHash has no currentPinHash, setting to newPin",t),p(t);if(!await r.compare(String(e),String(s)))throw new n("Current pin entered is incorrect.",{current_pin:["Incorrect pin entered."]});return p(t)},getPinHash:u,authenticate:async function(e){if(d++,d>=5&&(c&&clearTimeout(c),c=setTimeout((()=>{d=0}),15e3),1))throw new n("Please try again in 15 seconds.",{pin:["Please wait 15 seconds and try again..."]});const t=await u();if(!t)throw new n("Current pin entered is incorrect.",{pin:["Please set a pin before trying to authenticate."]});if(!await r.compare(String(e),String(t)))throw new n("Incorrect pin sorry.",{current_pin:["Incorrect pin entered."]});return t}}},5653:(e,t,s)=>{s(1017);const r=s(7147),i=s(2167),o=s(3619);let n=null;const{ValidationError:a}=s(5636),c=`${o.rootDataDir}/.BTBEARER`;let l=null;function d(){if(console.log("burntable.getBearer()"),l)return console.log("using bearer cache",l),l;try{if(r.existsSync(c))return l=r.readFileSync(c,"utf8"),console.log("Setting BT_BEARER_CACHE",l),l;console.log("No bearer file --",c)}catch(e){return console.log("No bearer file",c),null}}e.exports={getBearer:d,setBearer:async function(e){return r.writeFileSync(c,e,{encoding:"utf8",flag:"w"}),l=e,e},deleteBearer:async function(){try{r.rmSync(c),l=null}catch(e){console.error("Failed to delete burntable bearer file.")}return!0},getClient:function(){return n?(d()&&(n.defaults.headers.authorization="Bearer "+d()),n):(n=i.create({baseURL:"https://burntable.com/api",headers:{accept:"application/json","content-type":"application/json"}}),n.defaults.headers.authorization="Bearer "+d(),console.log("getClient axiosInstance.defaults.headers",n.defaults.headers),n)}}},9549:(e,t,s)=>{const r=s(2544);r.setMode(r.MODE_BCM);const i=s(4525),o=r.promise;let n=null,a=0,c=!0,l=null,d=null;e.exports={observe:async function(e){await o.setup(3,r.DIR_IN,r.EDGE_BOTH),o.on("change",(function(t,s){c!==s&&(c=s,!1===s?n=setInterval((()=>{a++,4===a?"wants_sleep"!=l&&(l="wants_sleep",i.flashAll(1,500),e("wants_sleep")):10===a?"wants_reboot"!=l&&(l="wants_reboot",i.flashAll(2,500),e("wants_reboot")):29===a?"wants_factory_reset"!=l&&(i.flashAll(8,250),l="wants_factory_reset",e("wants_factory_reset")):a>40&&(a=0,l=null,clearInterval(n))}),1e3):(a>29?"factory_reset"!=l&&(l="factory_reset",e("factory_reset")):a>=10?"reboot"!=l&&(l="reboot",e("reboot")):a>=4?"sleep"!=l&&(l="sleep",e("sleep")):"stop"!=l&&(l="stop",e("stop")),null===d&&(d=setTimeout((()=>{l=null,clearTimeout(d),d=null}),250)),a=0,n&&(console.log("clearInterval holdInterval"),clearInterval(n),n=null)))}))}}},6212:(e,t,s)=>{const r=s(5597),i=s(2353),{spawn:o}=s(2081),n=s(7147),a=s(4386);e.exports=class extends r{session;jobState;normalizedFiles=[];maxVolumes=[];maxVolumeProcs=[];applyGainProcs=[];reportingInterval;constructor(e){super(),this.session=e}getId(){return this.session?`Normalizer-${this.session.id}`:null}getTitle(){return`Peak normalizing ${this.session.title} audio`}getJobState(){return this.jobState}async stop(){await this.killProcesses([...this.maxVolumeProcs,...this.applyGainProcs]),await this.removeFiles(this.normalizedFiles),this.reportingInterval&&clearInterval(this.reportingInterval)}async process(){return this.jobState={object:"Session",object_id:this.session.id,data:{...this.session},id:this.getId(),title:`Normalizing ${this.session.title}`,name:"normalize",status:"Peak-normalizing session",completed:!1,progress:!0},this.reportingInterval=setInterval((()=>{this.jobState.data={...this.session},a.pub("job",this.jobState)}),3e3),(async()=>{for(const e of this.session.recordings){this.jobState.status=`Getting max volume of side ${e.side}`;let t=await this.getMaxVolume(e.file);if(null===t)throw new Error(`Failed to determine max volume of audio ${e.id} in ${e.file}.`);this.jobState.status=`Max volume of side ${e.side}: ${t}`,this.maxVolumes.push(t)}this.maxVolume=Math.max(...this.maxVolumes);const e=Math.abs(this.maxVolume);this.jobState.status=`Gain required: ${e}dB`;for(const t of this.session.recordings){this.jobState.status=`Applying gain to side ${t.side}`;let s=await this.applyGain(new i(t),e);t.file=s,t.state="normalized",this.session.ensureRecording(t)}this.session.normalized=!0,this.session.save()})().then((()=>{console.log("Normalizer.process() done")})).catch((e=>{console.error("Normalizer.process.catch",e),this.jobState.error=`Normalization failed: ${e.message||e}`})).finally((()=>{this.reportingInterval&&clearInterval(this.reportingInterval),this.jobState.completed=!0,a.pub("job",this.jobState)})),this.jobState}async applyGain(e,t){const s=e.pathForVariant("file","normalized");let r=["-hide_banner","-y","-i",e.file],i="";if(!(t>0))return n.cpSync(e.file,s),s;i=`volume=${t}dB`;const a=`${i}`;return r.push("-filter_complex"),r.push(a),r.push(s),console.log("Normalizer.applyGain() rawArgs",r),new Promise(((t,i)=>{if(e.file===s)return i(`Side ${e.side} already normalized. Please reset session to capture state.`);const a=o("ffmpeg",r);a.on("error",(e=>{i(e)})),a.on("close",(()=>{console.log("applyGainProc CLOSE (ignoring)")})),a.on("exit",(()=>{console.log("applyGainProc EXIT"),n.existsSync(s)?(this.normalizedFiles.push(s),t(s)):i("Normalizer failed to create output file")})),a.stdout.on("data",(e=>{console.log("applyGain.stdout",e.toString())})),a.stderr.on("data",(e=>{console.log("applyGain.stderr",e.toString())})),this.applyGainProcs.push(a)}))}async getMaxVolume(e){let t=`-hide_banner -i ${e} -af volumedetect -f null /dev/null`;return new Promise(((e,s)=>{const r=o("ffmpeg",t.split(" "));let i=!1;r.on("error",(e=>{s(e)})),r.on("close",(()=>{console.log("getMaxVolume CLOSE (ignoring)")})),r.on("exit",(()=>{i||e(null)})),r.stdout.on("data",(e=>{})),r.stderr.on("data",(t=>{let s=t.toString().match(/max_volume:\s(-?\d+\.\d+)/i);if(s){i=!0;let t=parseFloat(s[1]);return console.log("getMaxVolume",t),e(t)}})),this.maxVolumeProcs.push(r)}))}}},3882:(e,t,s)=>{const r=s(4386),{spawn:i}=s(2081),o=(s(1041),s(8370),s(5597));e.exports=class extends o{session;side;recording;reportingInterval;jobState;referenceProc;referenceFile;waveformProc;waveformFile;constructor(e,t){super(),this.session=e,this.side=t}getId(){return this.recording?`PostCapture-${this.recording.id}`:null}getTitle(){return this.recording&&this.session?`${this.session.title} Side ${this.recording.side} post-capture`:null}getJobState(){return this.jobState}async stop(){return await this.killProcesses([this.referenceProc,this.waveformProc]),await this.removeFiles([this.referenceFile,this.waveformFile]),this.reportingInterval&&clearInterval(this.reportingInterval),this.recording.post_capturing=!1,this.recording.post_captured=!1,this.session.ensureRecording(this.recording)}async process(){if(this.recording=await this.session.getRecording(this.side),this.recording.post_capturing)throw new Error("Post capture already in progress");return this.recording.post_capturing=!0,await this.session.ensureRecording(this.recording),this.jobState={object:"Recording",object_id:this.recording.id,data:{...this.recording},id:this.getId(),title:`Post-capture for Side ${this.side}`,name:"waveform",status:"Processing waveform",completed:!1,progress:!0},this.reportingInterval=setInterval((()=>{this.jobState.data={...this.recording},r.pub("job",this.jobState)}),3e3),(async()=>{const e=await this.generateReference();this.recording.waveform=await this.generateWaveform(e),this.recording.reference=e,this.recording.post_captured=!0,this.recording.state="post_captured",await this.recording.syncFileInfo()})().then((()=>{console.log("Finished creating waveform and reference")})).catch((e=>{console.log("PostCapture.process.catch"),this.jobState.error=`Post capture failed: ${e.message}`})).finally((async()=>{this.reportingInterval&&clearInterval(this.reportingInterval),console.log("PostCapture.process.finally"),this.jobState.completed=!0,this.recording.post_capturing=!1,this.jobState.data={...this.recording},await this.session.ensureRecording(this.recording),r.pub("job",this.jobState),console.log("end finally")})),this.jobState}async generateReference(){this.referenceFile=this.recording.pathForVariant("reference","post_captured"),this.jobState.status="Generating optimized audio for editing";let e=`-y -i ${this.recording.file} -ar 48000 -b:a 128k ${this.referenceFile}`;return new Promise(((t,s)=>{this.referenceProc=i("ffmpeg",e.split(" ")),this.referenceProc.on("error",(e=>{s(e)})),this.referenceProc.on("close",(()=>{console.log("generateWaveformSource mp3 CLOSE (ignoring)")})),this.referenceProc.on("exit",(()=>{console.log("generateWaveformSource mp3 EXIT"),setTimeout((()=>{t(this.referenceFile)}),250)})),this.referenceProc.stdout.on("data",(e=>{console.log("generateWaveformSource.stdout",e.toString())})),this.referenceProc.stderr.on("data",(e=>{console.log("generateWaveformSource.stderr",e.toString())}))}))}async generateWaveform(e){console.log("Generating waveform from source file..."),this.waveformFile=this.recording.pathForVariant("waveform","post_captured");let t=`-y -i ${e} -filter_complex compand=gain=6,aformat=channel_layouts=mono,showwavespic=s=7200x240:colors=white -frames:v 1 ${this.waveformFile}`;return this.jobState.status="Creating high resolution waveform for editing",new Promise(((e,s)=>{this.waveformProc=i("ffmpeg",t.split(" ")),this.waveformProc.on("error",(e=>{s(e)})),this.waveformProc.on("close",(()=>{})),this.waveformProc.on("exit",(()=>{console.log("generateWaveform EXIT, succeeded"),e(this.waveformFile)})),this.waveformProc.stdout.on("data",(e=>{console.log("generateWaveform.stdout",e.toString())})),this.waveformProc.stderr.on("data",(e=>{}))}))}}},2353:(e,t,s)=>{const{exec:r}=s(2081),{existsSync:i}=s(7147),o=s(3619),n={original:[{name:"file",template:"%side.original.flac",legacyTemplate:"%side.flac"}],post_captured:[{name:"file",template:"%side.original.flac",legacyTemplate:"%side.flac"},{name:"reference",template:"%side.original.mp3",legacyTemplate:"%side.flac.mp3"},{name:"waveform",template:"%side.original.png",legacyTemplate:"%side.flac.png"}],trimmed:[{name:"file",template:"%side.trimmed.flac",legacyTemplate:"%side.flac.t.flac"},{name:"reference",template:"%side.trimmed.mp3",legacyTemplate:"%side.flac.mp3.t.mp3"},{name:"waveform",template:"%side.trimmed.png",legacyTemplate:"%side.flac.png.t.png"}],normalized:[{name:"file",template:"%side.normalized.flac"},{name:"reference",template:"%side.trimmed.mp3",legacyTemplate:"%side.flac.mp3.t.mp3"},{name:"waveform",template:"%side.trimmed.png",legacyTemplate:"%side.flac.png.t.png"}]};e.exports=class{id;session_id;created_at;post_captured=!1;post_capturing=!1;file;reference;waveform;side;seconds;rate;format;bits;state=null;trimmed=!1;trimming=!1;trimmedFrom;trimmedTo;filesize;constructor(e){Object.keys(e).forEach((t=>{this[t]=e[t]})),e.id||(this.id=`${e.session_id}-${e.side}`)}async setActiveState(e){switch(this.state=e,this.post_capturing=!1,this.trimming=!1,e){case"original":this.post_captured=!1,this.trimmed=!1,this.normalized=!1;break;case"post_captured":this.post_captured=!0,this.trimmed=!1,this.trimmedFrom=null,this.trimmedTo=null,this.normalized=!1;break;case"trimmed":this.post_captured=!0,this.trimmed=!0,this.normalized=!1}}async getStateInferred(){return this.state?this.state:this.post_captured||this.trimmed||this.normalized?this.normalized?"normalized":this.trimmed?"trimmed":"post_captured":"original"}async setActiveFileState(e){for(const t of variants){const s=this.getExistingVariantPath(t.name,e);s&&(this[t.name]=s)}}async debug(){let e=await this.getStateInferred();return{state:this.state,inferredState:e,activeFilesForState:{file:this.getExistingVariantPath("file",e),reference:this.getExistingVariantPath("reference",e),waveform:this.getExistingVariantPath("waveform",e)}}}audioPath(){return`${o.dataDir}/sessions/${this.session_id}/audio`}nameForVariant(e,t){let s=n[t].find((t=>t.name===e));if(!s)throw new Error(`The variant '${e}' is not a valid variant name`);try{return s.template.replace("%side",this.side)}catch(e){return!1}}pathForVariant(e,t){let s=this.nameForVariant(e,t);return s?`${this.audioPath()}/${s}`:null}getExistingVariantPath(e,t){let s=n[t].find((t=>t.name===e));if(!s)throw new Error(`The variant '${e}' is not a valid variant name`);try{let r=[this.nameForVariant(e,t)];s.legacyTemplate&&r.push(s.legacyTemplate.replace("%side",this.side));for(const e of r){let t=`${this.audioPath()}/${e}`;if(this.pathIfExists(t))return t}return null}catch(e){return!1}}pathIfExists(e){try{return i(e)}catch(e){return null}}async getInfoForAudio(e){return new Promise(((t,s)=>{r(`ffprobe ${this[e]}`,((e,r,i)=>{if(e)return s(e.message);if(i){let e={seconds:0,rate:null,format:null,bits:null};const s=/Duration: (\d{2}):(\d{2}):(\d{2}).(\d{1,2}),/gm.exec(i);s&&s[1]&&(e.seconds+=3600*parseInt(s[1]),e.seconds+=60*parseInt(s[2]),e.seconds+=parseInt(s[3]),e.seconds+=parseInt(s[4])/100);const r=/Audio: ([a-z0-9]+),\s?(\d+)\s?Hz/gm.exec(i);r&&r[1]&&(e.format=r[1].trim(),e.rate=parseInt(r[2]));const o=/Audio:.+\((\d+)\sbit\)/gm.exec(i);o&&o[1]&&(e.bits=parseInt(o[1])),t(e)}}))}))}async syncFileInfo(){const e=await this.getInfoForAudio("file");return console.log("Recording.syncFileInfo",e),Object.keys(e).forEach((t=>{this[t]=e[t]})),e}async getInfo(){const e=await this.getInfoForAudio("file");return Object.keys(e).forEach((t=>{this[t]=e[t]})),e}}},1272:(e,t,s)=>{const r=s(5597),i=s(4386),{ValidationError:o}=(s(2353),s(6217),s(5636));let n=["Recording"];e.exports=class extends r{jobState;session;objectType;objectId;state;reportingInterval;constructor(e,t,s,r){if(super(),n.indexOf(t)<0)throw new Error(`Cannot revert ${t}, not supported.`);this.session=e,this.objectType=t,this.objectId=s,this.state=r}getId(){return`Reverter-${this.objectType}-${this.objectId}`}getJobState(){return this.jobState}getTitle(){return`Reverting ${this.objectType} ${this.objectId} to ${this.state}`}async stop(){return null}async process(){return this.jobState={object:this.objectType,object_id:this.objectId,data:null,id:this.getId(),title:this.getTitle(),name:"revert",status:`Reverting to ${this.state}`,completed:!1,progress:!0},this.reportingInterval=setInterval((()=>{i.pub("job",this.jobState)}),3e3),"Recording"===this.objectType&&await this.validateForRecording(),(async()=>{"Recording"===this.objectType&&await this.processRecording(),await this.session.save()})().then((()=>{})).catch((e=>{console.error("Reverter.process() exception",e),this.jobState.error=e.message||e})).finally((()=>{this.reportingInterval&&clearInterval(this.reportingInterval),this.jobState.completed=!0,console.log("Reverter.process() finally",this.jobState),i.pub("job",this.jobState)})),this.jobState}async validateForRecording(){let e=["original","post_captured","trimmed","normalized"];if(e.indexOf(this.state)<0)throw new Error("Not a valid reversion state");let t=await this.session.getRecordingById(this.objectId);if(!t)throw new Error("Not a valid recording id for this session");let s=await t.getStateInferred();if(e.indexOf(this.state)>=e.indexOf(s))throw new o("Cannot revert.",[{state:["Cannot revert to current or forward state."]}])}async processRecording(){let e=await this.session.getRecordingById(this.objectId);if(this.session.normalized=!1,"original"===this.state){let t=e.getExistingVariantPath("file",this.state);t&&(e.file=t,e.reference=null,e.waveform=null,await e.setActiveState("original"))}else if("post_captured"===this.state){let t=e.getExistingVariantPath("file","post_captured");if(t){e.file=t;let s=!0;for(const t of["waveform","reference"]){let r=e.getExistingVariantPath(t,"post_captured");r?e[t]=r:s=!1}s?await e.setActiveState("post_captured"):(e.reference=null,e.waveform=null,await e.setActiveState("original"))}}else if("trimmed"===this.state&&e.getExistingVariantPath("file","trimmed")){let t=!0;for(const s of["waveform","reference"]){let r=e.getExistingVariantPath(s,"trimmed");r?e[s]=r:t=!1}t?await e.setActiveState("trimmed"):(e.reference=null,e.waveform=null,await e.setActiveState("original"))}await e.syncFileInfo(),this.jobState.data={...e},await this.session.ensureRecording(e)}}},6217:(e,t,s)=>{const r=s(2345),i=s(7147),o=s(3619),n=s(2353);e.exports=class{id;drop_id;id_discogs;title;description;release_version;created_at;updated_at;recordings=[];uploads=[];normalizing=!1;normalized=!1;image;constructor(){}async ensureRecording(e){if(console.log("Session.ensureRecording",e),!e.side||!e.session_id)return void console.error("Cannot ensureRecording without required fields");e.id||(e.id=`${e.session_id}-${e.side}`),this.load(this.id);let t=this.recordings.findIndex((t=>t.side===e.side));return t>-1?this.recordings[t]={...e}:this.recordings.push({...e}),this.save()}ensureUpload(e){this.uploads.push(e)}create(e){const t=Math.round(Date.now()/1e3);this.id=t,this.title=e,this.drop_id=null,this.created_at=t,this.updated_at=t,this.save()}audioDir(){return`${o.dataDir}/sessions/${this.id}/audio`}async update(e){if(!this.id)throw new Error("Cannot update without id");const t=["title","description"];for(const s of t)e[s]&&(this[s]=e[s]);return this.save()}updateReleaseVersion(e){return this.release_version=e,this.id_discogs=e.id,r.put(`sessions.${this.id}.release_version`,e),this.save()}load(e){let t=this;const s=r.get(`sessions.${e}.session`);if(!s)throw new Error(`Invalid session id ${e}`);Object.keys(s).forEach((e=>{t[e]=s[e]})),t.recordings.forEach((e=>{e.id||(e.id=`${e.session_id}-${e.side}`)}))}async save(){return await r.lockPut(`sessions.${this.id}.session`,{...this}),this.toJSON()}async deleteSide(e){this.load(this.id);let t=this.recordings.findIndex((t=>t.side===e));if(t<0)return!1;let s=new n(this.recordings[t]),r=`${this.audioDir()}/${e}`,o=[`${r}.flac`,`${r}.flac.png`,`${r}.flac.mp3`,`${r}.flac.t.flac`,`${r}.flac.png.t.png`,`${r}.flac.mp3.t.mp3`];s.trimmed;for(const e of o)try{i.unlinkSync(e)}catch(t){console.log(`Didn't delete ${e} because it didn't exist`)}try{return this.recordings.splice(t,1),await this.save(),!0}catch(e){return console.error(e),!1}}async getRecording(e){let t=this.recordings.findIndex((t=>t.side===e));if(t<0)throw new Error("No side found.");return new n(this.recordings[t])}async getRecordingBySide(e){return this.getRecording(e)}async getRecordingById(e){let t=this.recordings.findIndex((t=>(t.id||(t.id=`${t.session_id}-${t.side}`),t.id===e)));if(t<0)throw new Error("No side found.");return new n(this.recordings[t])}getSessionDir(){return`${o.dataDir}/sessions/${this.id}`}async updateImage(e){try{const t=s(7441);let r=`${this.getSessionDir()}/image.jpg`,i=await t(e).resize(1200,1200).jpeg({quality:70}).toFile(r);console.log("sharp image ",i),this.image=r,this.save()}catch(e){}}toJSON(){return{...this}}}},4408:(e,t,s)=>{const{EventEmitter:r}=s(1239),i=s(7147),o=s(2353),n=s(3361),a=s(4525),c=s(4386),l=s(3619),d=s(3489),p=s(1041),{exec:u,execSync:h,spawn:g}=s(2081);e.exports=new class extends r{duration;jack_capture;flacFile;levelReportingInterval;secondsReportingInterval;ledInterval;waveFormSourceFile;jackManager;preferredSampleRate;preferredFormat;preferredAutoStopSeconds;session;side;seconds;constructor(){super(),this.jackManager=n,this.preferredFormat=d.get("captureFormat"),this.preferredSampleRate=1e3*d.get("captureSampleRate"),this.preferredAutoStopSeconds=d.get("captureAutoStopSeconds")}async record(e,t){let s=this;if(console.log("Transport.record()",{session:e,side:t}),this.jack_capture)return void console.log("Transport jack_capture already exists. Aborting.");try{await this.jackManager.ensure(this.preferredSampleRate,!0),console.log(`Transport.record() jackd is running at ${this.preferredSampleRate}.`),await new Promise((e=>setTimeout(e,1e3)))}catch(e){throw new Error(`Could not ensure jack: ${e.message}`)}if(this.seconds=0,!e||!e.id)throw new Error("There is no session id");if(!t)throw new Error("There is no side (like A, B, C, D, etc...)");this.side=t,this.session=e;let r=d.get("captureFormat");console.log("Transport preferences captureFormat",r);let o="alac"===r?"alac":"flac",n=`${l.dataDir}/sessions/${this.session.id}/audio`;i.existsSync(n)||i.mkdirSync(n,{recursive:!0}),this.flacFile=`${n}/${t}.original.${o}`;let a=`-c 2 -p system:capture* -f ${r} --hide-buffer-usage --silent --meterbridge -fn ${this.flacFile}`;console.log(`jack_capture ${a}`),this.jack_capture=g("jack_capture",a.split(" ")),this.jack_capture.on("exit",(function(e,t){s.jack_capture=null,console.error(`jack_capture exited with code ${e} and signal ${t}`),s.emit("exit",`jack_capture exited with code ${e} and signal ${t}`)})),this.jack_capture.on("close",(function(e,t){s.jack_capture=null,s.secondsReportingInterval&&clearInterval(s.secondsReportingInterval),s.levelReportingInterval&&clearInterval(s.levelReportingInterval),console.error(`jack_capture closed with code ${e} and signal ${t}`),s.emit("close",`jack_capture closed with code ${e} and signal ${t}`)})),this.jack_capture.on("error",(function(e){try{this.emit("error",e)}catch(e){console.error(e)}})),this.jack_capture.stderr.on("data",(function(e){}));let p=!1,u=null;this.levelReportingInterval=setInterval((()=>{p=!0}),100);let h=!1;this.jack_capture.stdout.on("data",(e=>{if(h||(this.startReportingSeconds(),this.startLedRotation(),h=!0),!p)return;const t=e.toString().split(/[/\r\n]/);if(!t||!t[0]||!t[1])return;p=!1;const r=[s.extractLevelsFromBfrPart(t[0]),s.extractLevelsFromBfrPart(t[1])];if(0===r[0]||0===r[1])return s.emit("levels",u),void c.pub("levels",u);u=r,s.emit("levels",r),c.pub("levels",r)}))}startReportingSeconds(){this.seconds=0,this.secondsReportingInterval=setInterval((()=>{this.seconds++,this.seconds>this.preferredAutoStopSeconds&&this.stop();const e={side:this.side,offset:this.seconds,session_id:this.session.id,session:{...this.session}};c.pub("store",{name:"capture",data:e}),c.pub("store",{name:"session",data:{...this.session}})}),1e3)}startLedRotation(){let e=0;const t=[25,24,23];this.ledInterval=setInterval((()=>{t.map(((t,s)=>{h(s===e?`raspi-gpio set ${t} op pn dh`:`raspi-gpio set ${t} op pn dl`)})),e++,3===e&&(e=0)}),900)}extractLevelsFromBfrPart(e){const t=/(\d{2}):\|(\-+)\s+?\*?\s+\|$/g.exec(e);return t&&t[2]?t[2].length:0}async stop(){if(await a.setAllLeds(!1),await a.flashAll(3,500),this.jack_capture&&this.jack_capture.pid){console.log(`Killing jack capture ${this.jack_capture.pid}`),p(this.jack_capture.pid),this.jack_capture=null,this.levelReportingInterval&&clearInterval(this.levelReportingInterval),this.ledInterval&&clearInterval(this.ledInterval);try{console.log("Transport.stop()");let e=new o({id:`${this.session.id}-${this.side}`,created_at:Math.round(Date.now()/1e3),session_id:this.session.id,file:this.flacFile,post_captured:!1,waveform:null,reference:null,side:this.side,rate:this.preferredSampleRate,format:this.preferredFormat,state:"original"});return await e.syncFileInfo(),console.log("stop() ensuring recording and saving session..."),await this.session.ensureRecording(e),c.pub("store",{name:"capture",data:null}),e}catch(e){return{waveform:null,error:e.message}}}else console.log("Transport: received stop() but I was not recording")}isRecording(){return null!=this.jack_capture}filename(){}}},53:(e,t,s)=>{const r=s(4386),i=s(7147),o=(s(8370),s(5597)),{spawn:n}=(s(3619),s(3489),s(1041),s(2081)),a=s(7441);e.exports=class extends o{trimming=!1;trimProc;trimReferenceProc;trimFileOutput;trimWaveformOutput;tmpReference;session;side;recording;from;to;reportInterval;jobState;constructor(e,t){super(),this.session=e,this.side=t}getId(){return this.recording?`Trimmer-${this.recording.id}`:null}getTitle(){return this.recording&&this.session?`Trimming ${this.session.title} Side ${this.recording.side}`:null}getJobState(){return this.jobState}async stop(){return await this.killProcesses([this.trimReferenceProc,this.trimProc]),await this.removeFiles([this.trimFileOutput,this.trimWaveformOutput,this.tmpReference]),this.recording.trimming=!1,this.recording.trimmedFrom=null,this.recording.trimmedTo=null,this.reportingInterval&&clearInterval(this.reportingInterval),this.session.ensureRecording(this.recording)}async trim(e,t){this.recording=await this.session.getRecording(this.side),this.from=e,this.to=t,this.recording.trimming=!0,this.recording.trimmedFrom=e,this.recording.trimmedTo=t,await this.session.ensureRecording(this.recording),this.jobState={object:"Recording",object_id:this.recording.id,data:{...this.recording},id:this.getId(),title:`Trimming ${this.session.title} Side ${this.recording.side}`,name:"trim",status:"Trimming audio",error:null,completed:!1,progress:!0};try{return r.pub("job",this.jobState),this.reportInterval=setInterval((()=>{this.jobState.data={...this.recording},r.pub("job",this.jobState)}),3e3),Promise.all([this.trimFile(),this.trimReference(),this.trimWaveform()]).then((async e=>{this.reportInterval&&clearInterval(this.reportInterval),this.jobState.completed=!0,r.pub("job",this.jobState),this.recording.trimmed=!0,this.recording.state="trimmed",this.recording.trimming=!1,this.recording.file=e[0],this.recording.reference=e[1],this.recording.waveform=e[2],await this.recording.syncFileInfo(),await this.session.ensureRecording(this.recording),r.pub("store",{name:"session",data:{...this.session}}),this.trimming=!1})).catch((e=>{console.log("Trimmer.trim ERROR: ",e)})),this.jobState}catch(e){console.error("TRIMMER ERROR",e),this.jobState.completed=!0,this.jobState.error=`Error trimming: ${e.message}`,r.pub("job",this.jobState)}}async trimFile(){this.trimFileOutput=this.recording.pathForVariant("file","trimmed");const e=`-y -i ${this.recording.file} -ss ${this.from}s -to ${this.to}s ${this.trimFileOutput}`;return console.log(`Trimmer.trimFile(): ffmpeg ${e}`),new Promise(((t,s)=>{this.trimProc=n("ffmpeg",e.split(" ")),this.trimProc.on("close",(e=>{0===e?t(this.trimFileOutput):s(`Exited with code ${e} while trimming file`)})).on("error",(function(e){try{s(e)}catch(e){console.error(e)}}))}))}async trimReference(){this.referenceOutput=this.recording.pathForVariant("reference","trimmed"),this.tmpReference=this.recording.reference.replace(/\.[^/.]+$/,".t.mp3");const e=`-f ${this.recording.reference} ${this.mp3spltTime(this.from)} ${this.mp3spltTime(this.to)} -o @f.t`;return console.log(`Trimmer.trimReference(): mp3splt ${e}`),new Promise(((t,s)=>{this.trimReferenceProc=n("mp3splt",e.split(" ")),this.trimReferenceProc.on("close",(e=>{0===e?(console.log(`${this.tmpReference} >> ${this.referenceOutput}`),i.renameSync(this.tmpReference,this.referenceOutput),t(this.referenceOutput)):s(`Exited with code ${e} while trimming file`)})).on("error",(function(e){try{s(e)}catch(e){console.error(e)}}))}))}mp3spltTime(e){return`${Math.floor(e/60)}.${(e%60).toFixed(2)}`}async trimWaveform(){this.trimWaveformOutput=this.recording.pathForVariant("waveform","trimmed");const{width:e,height:t}=await a(this.recording.waveform).metadata(),s=this.from/this.recording.seconds*e,r=e-this.to/this.recording.seconds*e;return await a(this.recording.waveform).extract({left:Math.floor(s),top:0,width:Math.floor(e-(s+r)),height:t}).toFile(this.trimWaveformOutput,(function(e){})),this.trimWaveformOutput}}},3619:(e,t,s)=>{s(5142).config();const{resolve:r}=s(1017);process.env.DATA_DIR||(console.error('CANNOT RUN WITHOUT "DATA_DIR=" IN ENV'),process.exit());const i=process.env.DATA_DIR;e.exports={rootDataDir:i,dataDir:`${i}/data`,shareDir:`${i}/shared`,btHome:process.env.BT_HOME,dsApiPort:process.env.DS_API_PORT,dataIsMount:process.env.DATA_IS_MOUNT}},2345:(e,t,s)=>{const r=s(1017),i=s(7147),o=s(3619);let n={};function a(e,t){let s=function(e){return o.dataDir+"/"+e.split(".").join("/")+".json"}(e),n=JSON.stringify({...t},null,"\t");const a=r.dirname(s);return i.existsSync(a)||i.mkdirSync(a,{recursive:!0}),i.writeFileSync(s,n),!0}e.exports={get:function(e){let t=o.dataDir+"/"+e.split(".").join("/")+".json";if(!i.existsSync(t))return null;let s=i.readFileSync(t);return JSON.parse(s.toString("utf-8"))},put:a,lockPut:async function e(t,s){return new Promise(((r,i)=>{if(n[t]){if(n[t]>10)return i(`Failed to acquire lock for ${t}`);setTimeout((async()=>{n[t]++,await e(t,s)&&r(!0)}),50)}n[t]=1,a(t,s),delete n[t],r(!0)}))}}},6737:(e,t,s)=>{const{exec:r,execSync:i,spawn:o}=s(2081),n={mute:5,relay:17},a=s(2544),c=a.promise;async function l(e){return c.read(e)}async function d(){return[{name:"mute",value:await l(5)},{name:"relay",value:!await l(17)}]}(async()=>{a.setMode(a.MODE_BCM),await c.setup(5,c.DIR_IN,c.EDGE_NONE),await c.setup(17,c.DIR_IN,c.EDGE_NONE)})(),e.exports={index:d,update:async function(e){console.log("UPDATE",e);for(const t of Object.keys(e)){if(!n[t]){console.log("Not setting, name not in gpio map",t,n);continue}let s=!(!e[t]||"false"===e[t]||"lo"===e[t]),r=`raspi-gpio set ${n[t]} op pn ${s?"dh":"dl"}`;console.log(r),i(r)}return d()}}},4306:(e,t,s)=>{s(2081).exec,s(7147),s(3619),e.exports={get:async function(){return process.env.PORTAL_SSID}}},5636:e=>{class t extends Error{errors;constructor(e,t){super(e),this.name="ValidationError",this.errors=t}}e.exports={ValidationError:t}},8370:(e,t,s)=>{const r=s(7147),i=s(3619),o=s(4386);let n=[];const a=`${i.dataDir}/job.log`;let c=!1;async function l(){o.sub("job",(async e=>{if(e.completed){console.log("Logging completed job state");const t=n.findIndex((t=>t.id===e.id));t>-1&&n.splice(t,1),await async function(e){return new Promise(((t,s)=>{r.appendFile(a,JSON.stringify(e)+"\n",(function(e){if(e)return s(`Failed to write to job log: ${JSON.stringify(e)}`);Math.random()>.9&&(console.log("Truncating log file"),async function(){if(!c)return c=!0,new Promise(((e,t)=>{r.readFile(a,"utf8",(function(s,i){if(s)return c=!1,t(s);try{const t=i.split("\n").slice(-25);r.writeFileSync(a,t.join("\n"),"utf8"),e()}catch(e){t(e)}finally{c=!1}}))}))}().catch((e=>{console.error("Failed to truncate job file",e)}))),t()}))}))}(e)}}))}l().then((()=>{console.log("Initialized JobManager")})),e.exports={index:async function(){return n.map((e=>e))},start:async function(e,t){console.log(`JobManager started ${e} with id ${t.getId()}`);const s=n.findIndex((e=>e.id===t.getId()));if(s>-1)return n[s];n.push({type:e,id:t.getId(),instance:t})},stop:async function(e){const t=n.findIndex((t=>t.id===e));if(t<0)throw new Error("Invalid job id");try{return n[t].instance.stop(),!0}catch(t){throw new Error(`Failed to stop job (${e}) because job instance threw exception ${t.message}`)}},get:async function(e){const t=n.findIndex((t=>t.id===e));return t<0?null:n[t]},destroy:async function(e){const t=n.findIndex((t=>t.id===e));if(t<0)return console.warn(`No job with id ${e} to destroy.`),!1;try{return await n[t].instance.stop(),!0}catch(e){return console.error(`Error stopping job: ${e.message}`),!1}return n.splice(t,1),!0},init:l,findExisting:async function(e,t){const s=n.findIndex((s=>s.id===t&&s.type===e));return s>-1?n[s]:null}}},4525:(e,t,s)=>{const{exec:r,execSync:i,spawn:o}=s(2081);let n=null;const a={1:25,2:24,3:23};async function c(e,t){a[e]&&i(`raspi-gpio set ${a[e]} op pn ${t?"dh":"dl"}`)}async function l(e){c(1,e),c(2,e),c(3,e)}async function d(){return n&&clearInterval(n),l(!1)}async function p(e){e||(e=900);let t=0;const s=[25,24,23];n?clearInterval(n):n=setInterval((()=>{s.map(((e,s)=>{i(s===t?`raspi-gpio set ${e} op pn dh`:`raspi-gpio set ${e} op pn dl`)})),t++,3===t&&(t=0)}),e)}e.exports={setAllLeds:l,setLedState:c,flashAll:async function(e,t){t||(t=500);let s=0,r=!1,i=setInterval((()=>{s++,s>=2*e&&(l(!1),clearInterval(i)),r?(r=!1,l(!1)):(r=!0,l(!0))}),t)},startTransportRotation:p,stopTransportRotation:d,waveHi:async function(){await l(!1),await p(150),setTimeout((async()=>{await d(),await l(!0),setTimeout((async()=>{await l(!1)}),2e3)}),5e3)}}},1436:(e,t,s)=>{const r=s(4306),i=s(3619),{networkInterfaces:o}=s(2037),{Bonjour:n}=s(3423),a=new n,{existsSync:c}=s(7147);let l=!1;async function d(){const e=o();let t=[];for(const s of Object.keys(e))for(const r of e[s])"IPv4"!==r.family||r.internal||t.push(r.address);return 0===t.length?null:t[t.length-1]}e.exports={publish:async function(){if(c("/etc/avahi/services/ds.service"))return void console.log("Network skipping publish because avahi is configured.");const e=await r.get();console.log("Publishing bonjour",e),l&&(console.log("Unpublishing..."),await a.unpublishAll()),l=!0;let t={name:e,type:"http",port:i.dsApiPort||8081},s=await d();s&&console.log(`network got ipv4 using for publishing host ${s}`),setTimeout((()=>{console.log(`Publishing bonjour: ${JSON.stringify(t)}`),a.publish(t).on("up",(()=>{}))}),3e3)},ipv4:d}},7945:(e,t,s)=>{const{spawn:r,exec:i}=s(2081);e.exports={init:async function(){i("raspi-gpio set 13 op pn dl"),i("raspi-gpio set 6 op pn dh"),i("raspi-gpio set 26 pd && raspi-gpio set op pn dh"),i("raspi-gpio set 5 op pn dh"),i("raspi-gpio set 17 op pn dh"),i("raspi-gpio set 12 pu")}}},6552:(e,t,s)=>{const r=s(3361),i=(s(4525),s(6737)),o=s(4386),n=(s(3619),s(3489),s(1403));e.exports=new class{player;playable;playbackReportingInterval;playing=!1;buffering=!1;seconds=0;offset=0;state;constructor(){}async init(){await i.update({relay:!0}),await r.killIfRunning(),await r.changeSampleRate(96e3)}async quit(){if(console.log("MPV.quit()"),this.player)try{await this.player.quit()}catch(e){console.error(`MPV.quit() said ${e.message}`)}return o.pub("store",{name:"playback",data:{playable:null,state:null,offset:null,seconds:null,hmsOffset:null,hmsSeconds:null}}),!0}async play(e){this.playable=e,await this.init(),console.log(`Playing: ${e.uri}`),this.player=new n({app:"mpv",ipcPath:"/dropstation/media-ctl-socket",args:["--audio-device=alsa/ds_96"],media:`${e.uri}`}),this.state="playing",this.player.on("app-exit",(e=>{o.pub("store",{name:"playback",data:{playable:null,state:null,offset:null,seconds:null,hmsOffset:null,hmsSeconds:null}})})),this.player.launch((e=>{if(e)return console.error(e.message)})),this.player.on("playback-started",(()=>{})),this.player.on("playback",(t=>{"duration"===t.name?this.seconds=t.value:"time-pos"===t.name&&(this.offset=t.value),o.pub("store",{name:"playback",data:{playable:{...e},state:this.state,offset:this.offset,seconds:this.seconds,hmsOffset:this.niceHMS(this.offset),hmsSeconds:this.niceHMS(this.seconds)}})}))}async stop(){this.playbackReportingInterval&&clearInterval(this.playbackReportingInterval),this.player?this.player.stop():console.log("MPV: received stop() but I was not playing?")}async togglePlay(){"paused"===this.state?(this.state="playing",console.log("this.player.play"),this.player.play()):(this.state="paused",console.log("this.player.pause"),this.player.pause())}async fastForward(){const e=this.seconds-5;return this.offset<e&&(this.player.seek(this.offset+5),!0)}async rewind(){return this.offset>5&&(this.player.seek(this.offset-5),!0)}niceHMS(e){return!e||isNaN(parseInt(e))?"00:00:00":[e/3600,e%3600/60,e%60].map(this.format).join(":")}format(e){return`0${Math.floor(e)}`.slice(-2)}}},7567:e=>{e.exports=class{title;track;album;artist;image;uri;userid;username;avatar;id_discogs;rate=96e3;bits=24;format="flac";context_type;context_id;context;constructor(e){Object.assign(this,e)}}},3489:(e,t,s)=>{const r=s(9242),i={captureAutoStopSeconds:{type:"number",default:1800},captureSampleRate:{type:"number",enum:[48,96,192],default:96},captureFormat:{enum:["flac","alac"],default:"flac"},bar:{type:"string",default:"foo"}},o=new r({schema:i});o.all=()=>{let e=[];for(const t of Object.keys(i))e.push({name:t,value:o.get(t)});return e},o.keys=()=>Object.keys(i),e.exports=o},4386:e=>{e.exports=new class{channels={};constructor(){}sub(e,t){this.channels[e]||(this.channels[e]=[]),this.channels[e].push(t)}pub(e,t){if(this.channels[e])for(const s of this.channels[e])s(t)}}},3771:(e,t,s)=>{const{EventEmitter:r}=s(1239);e.exports=class extends r{mpv;duration;constructor(){super()}async init(){}async ensureMpv(){}async play(e,t){console.log("Player.play",{url:e,offset:t}),this.emit("duration",this.duration),console.log("fired")}async seek(e){return this.mpv.goToPosition(e)}async resume(){this.mpv.isPaused()&&this.mpv.resume()}async stop(){this.mpv.isRunning()&&await this.mpv.quit()}async pause(){if(!this.mpv.isPaused())return this.mpv.pause()}}},3271:(e,t,s)=>{const r=s(3771);let i=null;async function o(){return i||(i=new r,i)}e.exports={play:async function(e,t){await(await o()).play(e.url,t)},stop:async function(){await(await o()).stop()},pause:async function(){},seek:async function(e){}}},5597:(e,t,s)=>{const r=s(1041),i=s(7147);e.exports=class{getId(){throw"getId() not implemented"}getJobState(){throw"getJobState() not implemented"}getTitle(){throw"getTitle() not implemented"}async stop(){throw"stop() not implemented"}async killProcesses(e){for(const t of e)await this.killProcess(t).catch((e=>{console.warn(e)}))}async killProcess(e){return new Promise(((t,s)=>{try{e&&e.pid?r(e.pid,"SIGKILL",(r=>{if(r)return s(`Job.stop() failed to kill ${e.pid}: ${r}`);t(`Job.killProcess() killed ${e.pid}`)})):s(`Cannot kill ${typeof e} because it didn't exist as a property with a pid`)}catch(t){return s(`Job.killProcess().catch() failed to kill ${typeof e}: ${t.message}`)}}))}async removeFiles(e){for(const t of e)try{i.unlinkSync(t)}catch(e){console.log(`Didn't delete ${t} because it didn't exist`)}}}},6815:(e,t,s)=>{const r=s(5597),i=s(4386);e.exports=class extends r{id;reportingInterval;jobState;doneTimeout;constructor(){super(),this.id=Date.now()/1e3}getId(){return`MockJob-${this.id}`}getTitle(){return`MockJob id ${this.id}`}async stop(){this.reportingInterval&&clearInterval(this.reportingInterval),this.doneTimeout&&clearTimeout(this.doneTimeout),i.pub("job",{...this.jobState,completed:!0,error:"Stopped manually"})}async process(){return this.doneTimeout=setTimeout((()=>{clearInterval(this.reportingInterval),i.pub("job",{...this.jobState,completed:!0})}),1e4),this.jobState={object:"Mock",object_id:123,data:{id:123,title:"None - Mock Job"},id:this.getId(),title:"Mock Job",name:"mockjob",status:"Working very hard",completed:!1,progress:!0},this.reportingInterval=setInterval((()=>{i.pub("job",this.jobState)}),3e3),this.jobState}}},5647:e=>{"use strict";e.exports=require("@fastify/cors")},9450:e=>{"use strict";e.exports=require("@fastify/http-proxy")},2782:e=>{"use strict";e.exports=require("@fastify/multipart")},871:e=>{"use strict";e.exports=require("@fastify/static")},2167:e=>{"use strict";e.exports=require("axios")},7096:e=>{"use strict";e.exports=require("bcrypt")},3423:e=>{"use strict";e.exports=require("bonjour-service")},9242:e=>{"use strict";e.exports=require("conf")},5142:e=>{"use strict";e.exports=require("dotenv")},1239:e=>{"use strict";e.exports=require("events")},1442:e=>{"use strict";e.exports=require("fastify")},1403:e=>{"use strict";e.exports=require("media-player-controller")},2544:e=>{"use strict";e.exports=require("rpi-gpio")},7441:e=>{"use strict";e.exports=require("sharp")},1041:e=>{"use strict";e.exports=require("tree-kill")},5352:e=>{"use strict";e.exports=require("ws")},2081:e=>{"use strict";e.exports=require("child_process")},7147:e=>{"use strict";e.exports=require("fs")},2037:e=>{"use strict";e.exports=require("os")},1017:e=>{"use strict";e.exports=require("path")}},t={};function s(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,s),o.exports}(()=>{const e=s(5352),t=s(4386),{spawn:r,exec:i,execSync:o}=s(2081),n=s(1436),a=s(7147),c=s(3619),l=(s(4306),s(5898)),d=s(4525),p=s(3361),u=s(4408);c.dataIsMount&&console.log("MOUNTED: /dropstation recognized as mounted dedicated drive."),u.on("exit",(()=>{console.log("Transport.on(exit)")})),u.on("error",(e=>{console.error("Transport.on(error)",e)}));const h=s(9549);["/dropstation/data/sessions","/dropstation/shared"].map((e=>{a.existsSync(e)||(console.log(`Creating ${e}`),a.mkdirSync(e,{recursive:!0}))}));const g=s(7945);p.on("debug",console.debug),(async()=>{await g.init(),await d.waveHi(),await h.observe((async e=>{console.log(`button.observe ${e}`),"sleep"===e?(await d.flashAll(1,250),o("sudo poweroff")):"reboot"===e?(await d.flashAll(2,250),o("sudo reboot now")):"stop"===e&&(await d.flashAll(1,250),await n.publish(),u.isRecording()&&u.stop().then((e=>{})))})),await n.publish()})();const m=()=>{console.log("Cleaning up child processes...");try{o("killall jack_capture")}catch(e){console.log("jack_capture not running...")}try{o("killall jackd")}catch(e){console.log("jackd not running...")}process.exit()};process.on("SIGTERM",m),process.on("SIGINT",m);const f=c.dsApiPort||8081,{join:y}=s(1017),w=s(8558),b=s(3666),v=s(5193),S=s(5852),x=s(2945),j=s(6105),I=s(6863),$=s(9763),k=s(8264),_=s(6714),R=(s(267),s(1442)({logger:!1}));R.register(s(2782),{fileSize:1e7,files:1}),R.register(s(871),{root:c.dataDir,prefix:"/files",decorateReply:!1}),R.register(s(5647),{origin:!0,methods:["GET","PUT","POST","DELETE","OPTIONS"],exposedHeaders:["Content-Type","Authorization"],credentials:!0}),R.addHook("onRequest",(async(e,t)=>{if("/files/*"===e.routerPath)return;if("/management/auth"===e.routerPath&&["GET","POST"].indexOf(e.routerMethod)>-1)return;if("/management/authentication"===e.routerPath&&"POST"===e.routerMethod)return;let s=await l.getPinHash();!s||e.headers.dspin&&s===e.headers.dspin||t.code(403).send({message:"Access denied"})})),R.setErrorHandler((function(e,t,s){if(console.log("error handler",e.message,e.name,e.stack),"ValidationError"===e.name)return s.code(422).send(e.errors);s.code(500).send({message:"System Error",error:e.message})})),R.get("/management/auth",w.get),R.post("/management/auth",w.post),R.put("/management/auth",w.put),R.delete("/management/auth",w.del),R.post("/management/authentication",w.authentication);const P=s(202);R.register(P.proxyHandler),R.register(P.authHandler,{prefix:"/bt-auth"}),R.post("/playback/init",b.init),R.post("/playback",b.play),R.delete("/playback",b.quit),R.post("/playback/toggle_play",b.togglePlay),R.post("/playback/rewind",b.rewind),R.post("/playback/fast_forward",b.fastForward),R.post("/playback/skip_next",b.skipNext),R.post("/playback/skip_previous",b.skipPrevious),R.get("/sessions",x.index),R.post("/sessions",x.store),R.get("/sessions/:id",x.read),R.put("/sessions/:id",x.update),R.delete("/sessions/:id",x.destroy),R.delete("/sessions/:id/:side",x.deleteRecording),R.get("/sessions/:id/:side",x.getRecording),R.post("/sessions/:id/image",I.upload),R.post("/sessions/:id/recordings/:side/trim",S.store),R.post("/sessions/:id/recordings/:side/post_capture",v.storePostCapture),R.put("/sessions/:id/release_version",x.updateReleaseVersion),R.post("/sessions/:id/normalizations",k.store),R.post("/sessions/:id/:side/reversions",_.storeReversion),R.get("/jobs",$.index),R.post("/jobs",$.store),R.delete("/jobs/:id",$.destroy),R.post("/captures/record",v.record),R.post("/captures/stop",v.stop),R.get("/preferences",j.index),R.put("/preferences",j.update);const T=s(7534);R.get("/state",T.index),R.put("/state",T.update);const E=s(7232);R.post("/updates",E.store),R.get("/",(async(e,t)=>{t.send({message:"Welcome to DropStation."})})),(async()=>{try{await R.listen({port:3e3,host:"0.0.0.0"})}catch(e){R.log.error(e),process.exit(1)}})().then((()=>{console.log("started web server")}));let F=parseInt(f)+1;const O=new e.Server({host:"0.0.0.0",port:F});O.on("listening",(()=>{console.log("ws listening",F)}));const D=setInterval((()=>{O.clients.forEach((e=>{if(!1===e.isAlive)return e.terminate();e.isAliveTimeout=setTimeout((()=>{e.awaitingSup&&(console.log("ws: Client gone, terminating."),e.terminate())}),500),e.send("yo"),e.awaitingSup=!0}))}),5e3);O.on("close",(function(){clearInterval(D)})),O.on("connection",(function(e){e.isAlive=!0,e.awaitingSup=!1,e.on("message",(function(t){e.awaitingSup=!1})),t.sub("levels",(t=>{e.send(JSON.stringify({event:"levels",levels:t}))})),t.sub("store",(({name:t,data:s})=>{e.send(JSON.stringify({event:"store",name:t,data:s}))})),t.sub("job",(t=>{e.send(JSON.stringify({event:"job",job:t}))})),e.send(JSON.stringify({message:"Welcome to DropStation"}))}))})()})();